#!/bin/sh

. ./testvars

#BEFORE=/tmp/before
#AFTER=/tmp/after
#CMD_db2ldif=/usr/lib/dirsrv/slapd-*/db2ldif


if [ ! -d $BEFORE ]
then
	mkdir $BEFORE
	chmod a+rwx $BEFORE
fi

if [ ! -d $AFTER ]
then
        mkdir $AFTER
        chmod a+rwx $AFTER
fi
echo "save current data into $BEFORE/userRoot.ldif"

$CMD_db2ldif -n userRoot  -a $BEFORE/userRoot.ldif
cp -r /etc/dirsrv/slapd-*/schema $BEFORE/.
ls -al $BEFORE
echo "make sure you have ipa repo in place"

yum update ipa-server

echo "test the ldap updater"
/usr/sbin/ipa-ldap-updater -t
if [ $? == 2 ]
then
	/usr/sbin/ipa-ldap-updater 
	echo "saving data"
	$CMD_db2ldif -n userRoot  -a $AFTER/userRoot.ldif
	cp -r /etc/dirsrv/slapd-*/schema $AFTER/.
	echo "upgrade ipa server done"
else
	echo "the ipa-ldap-updater test failed"
fi
