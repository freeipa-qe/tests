#!/bin/sh

. ./testvars

injector(){

  layermax=$1
  grpmax=$2
  usrmax=$3
  echo "layer=($layermax), goups per layer ($grpmax), users per group ($usrmax)"

  if [ -z $layermax ] || [ -z $grpmax ] || [ -z $usrmax ]
  then
        echo "the function call error, please call as : injector <total layer> <groups per layer> <users per group>"
        exit
  fi

  echo "modify the max length of username"
  ipa-defaultoptions --maxusername=16

  grpcounter=0
  usrcounter=0
  layercounter=0

  # create top layer groups
  echo "layer=$layercounter"
  while [ $grpcounter -lt $grpmax ]
  do
        groupname=grp-$layercounter$grpcounter
        desc="auto_add_$groupname"
        echo "   create group ($groupname)"
        ipa-addgroup $groupname -d $desc > /dev/null 2>&1
        ((grpcounter=grpcounter+1))
  done
  upperlayer=0
  layercounter=1
  while [ $layercounter -lt $layermax ]
  do
        echo "layer=$layercounter"
        grpcounter=0
        while [ $grpcounter -lt $grpmax ]
        do
                uppergroup=grp-$upperlayer$grpcounter
                groupname=grp-$layercounter$grpcounter
                desc="auto_add_$groupname"
                echo "   create group ($groupname), and append it to upper group ($uppergroup) "
                ipa-addgroup -d $desc  $groupname > /dev/null 2>&1
                ipa-modgroup -g $groupname $uppergroup > /dev/null 2>&1
                usrcounter=0
                while [ $usrcounter -lt $usrmax ]
                do
                        lastname="$layercounter$grpcounter-$usrcounter"
                        firstname="z"
                        username="$firstname-$lastname"
                        password=redhat123
                        shell="/bin/bash"
                        homedir="/home/$username"
                        echo "      add user ($username) and append to group ($groupname)"
                        ipa-adduser -c GECOS -d $homedir -f $firstname -l $lastname -p $password -s $shell $username > /dev/null 2>&1
                        ipa-modgroup -a $username $groupname > /dev/null 2>&1
                        ((usrcounter=usrcounter+1))
                        #echo "usrcounter=($usrcounter) usrmax=($usrmax)"
                done
                ((grpcounter=grpcounter+1))
        done
        ((layercounter=layercounter+1))
        ((upperlayer=upperlayer+1))
  done
}

LAYER=$1
GROUPS_PER_LAYER=$2
USERS_PER_GROUP=$3

echo "redhat123" | kinit admin >/dev/null 2>&1
if [ -z $LAYER ] || [ -z $GROUPS_PER_LAYER ]|| [ -z $USERS_PER_GROUP ]
then
	echo "use default: 5 layers, 2 groups per layer, 10 users per group."
	injector 5 2 10 
else
	injector $LAYER $GROUPS_PER_LAYER $USERS_PER_GROUP
fi

