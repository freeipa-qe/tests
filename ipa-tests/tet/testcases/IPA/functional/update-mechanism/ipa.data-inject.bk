#!/bin/sh
# date: Nov. 20, 2008
# by  : yi zhang
#     : used to inject a customized data into targeted ipa server. 

###################### GLOBAL VARIABLES #############
# all environment related variable are stored in 'localenvvars' file
. ./localenvvars



###################################################

usage(){
  if [ -f $usagefile ];then
	cat $usagefile
  else
	echo "no usage file found, it should be [$usagefile]"
  fi
}

readargs(){
  if [ -z $ipaserver ]
  then
	usage
	exit
  fi

  if [ -z $dsize ]; then
	usage
	echo "using default data size : small"
	dsize="small"
	return
  fi
}

keepgoing(){
  goon=""
  while [ -z $goon ]
  do 
	read goon
	if [ $goon = "y" ]
	then
		echo "yes sir, test will continue"
	elif [ $goon = "n" ]
	then
		echo "ok, test terminated" 
		exit
	else
		echo "please type 'y' for yes to continue the test, 'n' to terminate the test"
		goon=""
  	fi
  done
}

kinit(){
  echo "clean up previous kerberos ticket"
  ssh root@$ipaserver kdestroy
  ### by expeirience, only when we run the same command (echo redhat123 | kinit admin) twice it will produce consistant output
  ### I don't know why
  kadmin=`ssh root@$ipaserver 'echo "redhat123" | kinit admin >/dev/null 2>&1'`
  kadmin=`ssh root@$ipaserver 'echo "redhat123" | kinit admin >/dev/null 2>&1'`
  kadmin=`ssh root@$ipaserver klist 2>&1`
  if echo $kadmin | grep "admin"
  then
        echo kinit success
  else
        echo kinit failed
  fi
}

injectdata(){
  # sample command as below
  # ssh root@$ipaserver 'ipa-adduser -c GECOS -d /home/u101 -f user -l 101 -p redhat123 -s /bin/bash u101'
  # ssh root@$ipaserver 'ipa-addgroup -d "group 001" grp001'
  finish=""
  while [ -z $finish ]
  do
	if [ $dsize = "small" ];then
		small
		finish="finish"
	elif [ $dsize = "middle" ];then
		middle
		finish="finish"
	elif [ $dsize = "large" ];then
		large
		finish="finish"
	elif [ $dsize = "quit" ];then
		quit
	else
		echo "unknow data size option [$dsize]"
		echo "please enter [small|middle|large] (enter 'quit' to quit)"
		read dsize
	fi
 done
}

small(){
  echo "inject small set of data"
  echo "total 5 layer, 2 groups per layer, 10 users per group"
  injector 5 2 10
}

middle(){
  echo "inject middle set of data"
  echo "total layers 5, groups 150 per layer, 1000 uses per group"
  injector 5 10 100
}

large(){
  echo "inject large set of data"
  echo "total layers 100, 10 groups per layer, 2000 users per group"
  injector 100 100 1000
}

injector(){

  layermax=$1
  grpmax=$2
  usrmax=$3
  echo "layer=($layermax), goups per layer ($grpmax), users per group ($usrmax)"

  if [ -z $layermax ] || [ -z $grpmax ] || [ -z $usrmax ]
  then
	echo "the function call error, please call as : injector <total layer> <groups per layer> <users per group>"
	exit
  fi

  echo "modify the max length of username"
  ssh root@$ipaserver "ipa-defaultoptions --maxusername=16"

  grpcounter=0
  usrcounter=0
  layercounter=0

  # create top layer groups
  echo "layer=$layercounter"
  while [ $grpcounter -lt $grpmax ]
  do
	groupname=grp-$layercounter$grpcounter
	desc="auto_add_$groupname"
	echo "   create group ($groupname)"
	ssh root@$ipaserver "ipa-addgroup $groupname -d $desc > /dev/null 2>&1 "
	((grpcounter=grpcounter+1))
  done
  upperlayer=0
  layercounter=1   
  while [ $layercounter -lt $layermax ]
  do
	echo "layer=$layercounter"
	grpcounter=0
	while [ $grpcounter -lt $grpmax ]
	do
		uppergroup=grp-$upperlayer$grpcounter	
		groupname=grp-$layercounter$grpcounter
		desc="auto_add_$groupname"
		echo "   create group ($groupname), and append it to upper group ($uppergroup) "
		ssh root@$ipaserver "ipa-addgroup -d $desc  $groupname > /dev/null 2>&1"
		ssh root@$ipaserver "ipa-modgroup -g $groupname $uppergroup > /dev/null 2>&1"
		usrcounter=0
		while [ $usrcounter -lt $usrmax ]
		do
			lastname="$layercounter$grpcounter-$usrcounter"
			firstname="u"
			username="$firstname-$lastname"
			password=redhat123
			shell="/bin/bash"
			homedir="/home/$username"
			echo "      add user ($username) and append to group ($groupname)"
			ssh root@$ipaserver "ipa-adduser -c GECOS -d $homedir -f $firstname -l $lastname -p $password -s $shell $username > /dev/null 2>&1"
			ssh root@$ipaserver "ipa-modgroup -a $username $groupname > /dev/null 2>&1"
			((usrcounter=usrcounter+1))
			#echo "usrcounter=($usrcounter) usrmax=($usrmax)"
		done
		((grpcounter=grpcounter+1))
  	done
	((layercounter=layercounter+1))
	((upperlayer=upperlayer+1))
  done
}

quit(){
  echo "exiting testing"
  exit
}

##################### MAIN ##########################

ipaserver=$1
dsize=$2

readargs $0
echo "using ipaserver [$ipaserver] with data size [$dsize], continue? (y/n) "
keepgoing

echo "kinit as admin"
kinit

echo "injecting data now..."
injectdata

echo "continue"
