
# script called by either accept 
# or launch acceptance tests manually
if [ $# -lt 1 ]; then
	echo "usage:  launch [TestRoot] [complete path of build]"
	exit 1
fi
umask 0

echo "$*" | grep '64bit' >/dev/null 2>&1
if [ $? -eq 0 ]; then
	DST64=y
else
	DST64=n
	kname=`uname -s`
	if [ "$kname" = "Linux" ]; then
		echo "$*" | grep '_64.rpm' >/dev/null 2>&1
		if [ $? -eq 0 ]; then
			DST64=y
		fi
	elif [ "$kname" = "SunOS" ]; then
		echo "$*" | grep 'sparcv9.pkg' >/dev/null 2>&1
		if [ $? -eq 0 ]; then
			DST64=y
		fi
	elif [ "$kname" = "HP-UX" ]; then
		echo "$*" | grep '_64' >/dev/null 2>&1
		if [ $? -eq 0 ]; then
			DST64=y
		fi
	fi
fi

# This allows the admin server to startup successfully on RHEL3.
# cf. Bug #80932
# if [ "`uname -s`" = "Linux" ]; then
#	export LD_ASSUME_KERNEL=2.4.1
# fi

#
# figure out all the variable here
#
R=$1
BUILD=$2
VER=6.0
DSVERSION=8.0
ARCVER=`echo ${DSVERSION} | sed s'/\.//g'` # archive version used for path information
TESTCASE_ROOT=${R}/tetframework/testcases/IPA/$VER
REL=${R}
MAILID="ldap-devel-list@redhat.com"
UNIQID=`uname -n`.$$.`date '+%Y%m%d%H%M%S'`
PLAT=`uname`
if [ "$PLAT" = "Windows_NT" ]; then
	D=`echo $R | cut -d"/" -f1`
	tfile=${D}/tmp/engage.`hostname`.$$.cfg
else # unix
	D=""
	tfile=/tmp/engage.`hostname`.$$.cfg
fi

# Hack 
check=`uname -n`
case $check in
	works4you)  INSDISK=/export/svrbld/DS${DSVERSION}-$$/
		export INSDISK
		;;
	tmolus)  INSDISK=/export/svrbld/DS${DSVERSION}-$$/
		export INSDISK
		;;
	shadowfoot)  INSDISK=/export/svrbld/DS${DSVERSION}-$$/
		export INSDISK
		;;
	epsilon3)  INSDISK=/export/svrbld/DS${DSVERSION}-$$/
		export INSDISK
		;;
	tigger)  INSDISK=/export/svrbld/DS${DSVERSION}-$$/
		export INSDISK
		;;
	marcus)  INSDISK=/export/svrbld/DS${DSVERSION}-$$/
		export INSDISK
		;;
	*)	echo "INSDISK is not being set by launch"
		;;
esac

# set coredumpsize for Linux
if [ "$PLAT" = "Linux" ]; then
	ulimit -c unlimited	
	echo "*** ulimit -a: " 
	echo `ulimit -a`
fi

# sub the cfg file with the real values
# set -x
sed 's#\$SRCROOT#'$BUILD'#g
	 s#\$DRIVE#'$D'#g
	 s#\$REL#'${REL}'#g
	 s#\$VER#'${VER}'#g
	 s#\$ARCVER#'${ARCVER}'#g
	 s#\$PLAT#'${PLAT}'#g
	 s#\$MAILID#'${MAILID}'#g
	 s#\$DST64#'${DST64}'#g
	 s#\$UNIQID#'${UNIQID}'#g' \
		 ${R}/tetframework/data/DS/$VER/cfg/engage.acceptance.cfg > $tfile


echo "Running acceptance tests on `hostname` using $BUILD from $R"
echo "==========================================================="
echo "Content of the engage input file :"
cat $tfile
echo "==========================================================="
echo ksh $TESTCASE_ROOT/engage -c $tfile
ksh $TESTCASE_ROOT/engage -c $tfile
