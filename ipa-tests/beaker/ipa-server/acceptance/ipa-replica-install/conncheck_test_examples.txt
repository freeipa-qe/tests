    TCP
        80, 443: HTTP/HTTPS
        389, 636: LDAP/LDAPS
        88, 464: Kerberos 
    UDP
        88, 464: Kerberos
        123: NTP 

tmpout=/tmp/error_msg.out
rlRun "sftp root@$MASTERIP:/var/lib/ipa/replica-info-$SLAVE.gpg /opt/rhqa_ipa"

rlRun "ipa-replica-conncheck --master $MASTER --auto-master-check --realm $RELM --principal admin --hostname $SLAVE --password $ADMINPW > $tmpout 2>&1" 1
rlRun "ipa-replica-install -U --setup-dns --forwarder=$DNSFORWARD -w $ADMINPW -p $ADMINPW /opt/rhqa_ipa/replica-info-$SLAVE.gpg"

########### HTTP ###############
rlLog "Testing HTTP TCP and UDP port access"
rlRun "ssh root@$MASTERIP 'iptables -A INPUT -m tcp -p tcp --dport 80  -j REJECT --reject-with icmp-host-prohibited'"
rlRun "ipa-replica-install -U --setup-dns --forwarder=$DNSFORWARD -w $ADMINPW -p $ADMINPW /opt/rhqa_ipa/replica-info-$SLAVE.gpg > $tmpout 2>&1" 1
rlAssertGrep "HTTP Server: Unsecure port (80): FAILED" $tmpout
rlAssertGrep "Port check failed! Inaccessible port(s): 80 (TCP)" $tmpout
rlRun "cat $tmpout"
rlRun "ssh root@$MASTERIP 'iptables -D INPUT -m tcp -p tcp --dport 80  -j REJECT --reject-with icmp-host-prohibited'"

########### HTTPS ##############
rlLog "Testing HTTPS TCP port access"
rlRun "ssh root@$MASTERIP 'iptables -A INPUT -m tcp -p tcp --dport 443 -j REJECT --reject-with icmp-host-prohibited'"
rlRun "ipa-replica-install -U --setup-dns --forwarder=$DNSFORWARD -w $ADMINPW -p $ADMINPW /opt/rhqa_ipa/replica-info-$SLAVE.gpg > $tmpout 2>&1" 1
rlAssertGrep "HTTP Server: Secure port (443): FAILED" $tmpout
rlAssertGrep "Port check failed! Inaccessible port(s): 443 (TCP)" $tmpout
rlRun "ssh root@$MASTERIP 'iptables -D INPUT -m tcp -p tcp --dport 443 -j REJECT --reject-with icmp-host-prohibited'"

########### LDAP ##############
rlLog "Testing LDAP TCP port access"
rlRun "ssh root@$MASTERIP 'iptables -A INPUT -m tcp -p tcp --dport 389 -j REJECT --reject-with icmp-host-prohibited'"
rlRun "ipa-replica-install -U --setup-dns --forwarder=$DNSFORWARD -w $ADMINPW -p $ADMINPW /opt/rhqa_ipa/replica-info-$SLAVE.gpg > $tmpout 2>&1" 1
rlAssertGrep "Directory Service: Unsecure port (389): FAILED" $tmpout
rlAssertGrep "Port check failed! Inaccessible port(s): 389 (TCP)" $tmpout
rlRun "ssh root@$MASTERIP 'iptables -D INPUT -m tcp -p tcp --dport 389 -j REJECT --reject-with icmp-host-prohibited'"

########### LDAPS ##############
rlLog "Testing LDAPS TCP port access"
rlRun "ssh root@$MASTERIP 'iptables -A INPUT -m tcp -p tcp --dport 636 -j REJECT --reject-with icmp-host-prohibited'"
rlRun "ipa-replica-install -U --setup-dns --forwarder=$DNSFORWARD -w $ADMINPW -p $ADMINPW /opt/rhqa_ipa/replica-info-$SLAVE.gpg > $tmpout 2>&1" 1
rlAssertGrep "Directory Service: Secure port (636): FAILED" $tmpout
rlAssertGrep "Port check failed! Inaccessible port(s): 636 (TCP)" $tmpout
rlRun "ssh root@$MASTERIP 'iptables -D INPUT -m tcp -p tcp --dport 636 -j REJECT --reject-with icmp-host-prohibited'"

########### Kerberos KDC TCP ##############
rlLog "Testing Kerberos KDC TCP port access"
rlRun "ssh root@$MASTERIP 'iptables -A INPUT -m tcp -p tcp --dport 88  -j REJECT --reject-with icmp-host-prohibited'"
rlRun "ipa-replica-install -U --setup-dns --forwarder=$DNSFORWARD -w $ADMINPW -p $ADMINPW /opt/rhqa_ipa/replica-info-$SLAVE.gpg > $tmpout 2>&1" 1
rlAssertGrep "Kerberos KDC: TCP (88): FAILED" $tmpout
rlAssertGrep "Port check failed! Inaccessible port(s): 88 (TCP)" $tmpout
rlRun "ssh root@$MASTERIP 'iptables -D INPUT -m tcp -p tcp --dport 88  -j REJECT --reject-with icmp-host-prohibited'"

########### Kerberos Kpasswd TCP ##############
rlLog "Testing Kerberos Kpasswd TCP port access"
rlRun "ssh root@$MASTERIP 'iptables -A INPUT -m tcp -p tcp --dport 464 -j REJECT --reject-with icmp-host-prohibited'"
rlRun "ipa-replica-install -U --setup-dns --forwarder=$DNSFORWARD -w $ADMINPW -p $ADMINPW /opt/rhqa_ipa/replica-info-$SLAVE.gpg > $tmpout 2>&1" 1
rlAssertGrep "Kerberos Kpasswd: TCP (464): FAILED" $tmpout
rlAssertGrep "Port check failed! Inaccessible port(s): 464 (TCP)" $tmpout
rlRun "ssh root@$MASTERIP 'iptables -D INPUT -m tcp -p tcp --dport 464 -j REJECT --reject-with icmp-host-prohibited'"

################################### UDP TESTS NOT NECESSARY ########################################

########### Kerberos KDC UDP  ##############
rlLog "Testing Kerberos KDC UDP port access"
rlRun "ssh root@$MASTERIP 'iptables -A INPUT -m udp -p udp --dport 88 -j REJECT --reject-with icmp-host-prohibited'"
rlRun "ipa-replica-install -U --setup-dns --forwarder=$DNSFORWARD -w $ADMINPW -p $ADMINPW /opt/rhqa_ipa/replica-info-$SLAVE.gpg > $tmpout 2>&1" 1
rlAssertGrep "REPLACMENOW" $tmpout
rlAssertGrep "REPLACEMENOW" $tmpout
rlRun "ssh root@$MASTERIP 'iptables -D INPUT -m udp -p udp --dport 88 -j REJECT --reject-with icmp-host-prohibited'"
#### THIS DOESN'T FAIL because conncheck says this:
# The following list of ports use UDP protocol and would need to be
# checked manually:
#   Kerberos KDC: UDP (88): SKIPPED
#   Kerberos Kpasswd: UDP (464): SKIPPED
rlRun "ssh root@$MASTERIP 'ipa-replica-manage -p $ADMINPW del $SLAVE -f'"
rlRun "ipa-server-install --uninstall -U"
rlRun "service sssd stop"
rlRun "rm -f /var/lib/sss/pubconf/kdcinfo.$RELM"

########### Kerberos Kpasswd UDP ##############
rlLog "Testing Kerberos Kpasswd UDP port access"
rlRun "ssh root@$MASTERIP 'iptables -A INPUT -m udp -p udp --dport 464 -j REJECT --reject-with icmp-host-prohibited'"
rlRun "ipa-replica-install -U --setup-dns --forwarder=$DNSFORWARD -w $ADMINPW -p $ADMINPW /opt/rhqa_ipa/replica-info-$SLAVE.gpg > $tmpout 2>&1" 1
rlAssertGrep "REPLACMENOW" $tmpout
rlAssertGrep "REPLACEMENOW" $tmpout
rlRun "ssh root@$MASTERIP 'iptables -D INPUT -m udp -p udp --dport 464 -j REJECT --reject-with icmp-host-prohibited'"
#### THIS DOESN'T FAIL becaucase conncheck says this:
# The following list of ports use UDP protocol and would need to be
# checked manually:
#   Kerberos KDC: UDP (88): SKIPPED
#   Kerberos Kpasswd: UDP (464): SKIPPED

########### NTP UDP ##############
rlLog "Testing NTP UDP port access"
rlRun "ssh root@$MASTERIP 'iptables -A INPUT -m udp -p udp --dport 123 -j REJECT --reject-with icmp-host-prohibited'"
rlRun "ipa-replica-install -U --setup-dns --forwarder=$DNSFORWARD -w $ADMINPW -p $ADMINPW /opt/rhqa_ipa/replica-info-$SLAVE.gpg > $tmpout 2>&1" 1
rlAssertGrep "REPLACMENOW" $tmpout
rlAssertGrep "REPLACEMENOW" $tmpout
rlRun "ssh root@$MASTERIP 'iptables -D INPUT -m udp -p udp --dport 123 -j REJECT --reject-with icmp-host-prohibited'"
#### THIS DOESN'T FAIL because conncheck doesn't check for NTP port access
