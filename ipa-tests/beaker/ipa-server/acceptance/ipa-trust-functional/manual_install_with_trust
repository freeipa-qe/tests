cat > /etc/yum.repos.d/rhel64.repo <<EOF
[rhel64]
name=rhel64
baseurl=http://download.devel.redhat.com/nightly/latest-RHEL6.4/6.4/Server/x86_64/os/
enabled=1
gpgcheck=0
skip_if_unavailable=1
EOF

yum -y install openssh-clients wget bind-utils net-tools

currenteth=$(route | grep ^default | awk '{print $8}')
ipaddr=$(hostname -i)
hostname=$(hostname)
hostname_s=$(hostname -s)

export MASTER=rhel6-1.example.com
export SLAVE=rhel6-2.example.com
export CLIENT=rhel6-3.example.com
export MASTER_S=$(echo $MASTER|cut -f1 -d.)
export SLAVE_S=$(echo $SLAVE|cut -f1 -d.)
export CLIENT_S=$(echo $CLIENT|cut -f1 -d.)
export MASTERIP=$(dig +short $MASTER)
export SLAVEIP=$(dig +short $SLAVE)
export CLIENTIP=$(dig +short $CLIENT)
export BEAKERMASTER=$MASTER
export BEAKERSLAVE=$SLAVE
export BEAKERCLIENT=$CLIENT

export ADMINID=admin
export ADMINPW=Secret123
export ROOTDN="cn=Directory Manager"
export ROOTDNPWD=Secret123
export DNSFORWARD=10.14.63.12
export DNSFORWARD=192.168.122.1
export RELM=TESTRELM.COM
export DOMAIN=testrelm.com
export BASEDN="dc=testrelm,dc=com"
export NISDOMAIN=ipatest
export NTPSERVER=clock.redhat.com

export ADSERVER="w2k8r2-1.adtestdom.com"
export ADSERVERIP="192.168.122.21"
export ADDOMAIN=$(echo $ADSERVER|cut -f2- -d.)

cp -af /etc/hosts /etc/hosts.ipabackup
sed -i "/^$ipaddr/d" /etc/hosts
sed -i s/$hostname//g /etc/hosts
sed -i s/$hostname_s//g /etc/hosts
echo "$ipaddr $hostname_s.$DOMAIN $hostname_s" >> /etc/hosts
cat /etc/hosts

cp /etc/sysconfig/network /etc/sysconfig/network.ipabackup
hostname $hostname_s.$DOMAIN
sed -i "/$hostname_s/d" /etc/sysconfig/network
echo "HOSTNAME=$hostname_s.$DOMAIN" >> /etc/sysconfig/network
cat /etc/sysconfig/network

# master/slave:
setenforce 0

#yum -y install "*ipa-server" bind expect krb5-workstation bind-dyndb-ldap krb5-pkinit-openssl
yum -y install "*ipa-server-trust-ad" samba4-winbind-clients bind-dyndb-ldap samba4-client

# client:
yum -y install nscd httpd curl mod_nss mod_auth_kerb 389-ds-base expect ntpdate "*ipa-admintools" "*ipa-client"

# master
ipa-server-install --setup-dns --forwarder=$DNSFORWARD \
  --hostname=$hostname_s.$DOMAIN -r $RELM -n $DOMAIN -p $ADMINPW \
  --ip-address=$ipaddr -P $ADMINPW -a $ADMINPW -U

chkconfig iptables off
service iptables stop
chkconfig ip6tables off
service ip6tables stop

yum -y install ipa-server-trust-ad samba4 samba4-winbind-clients \
  samba4-client

ipa-adtrust-install --netbios-name=$(echo $RELM|cut -f1 -d.) \
  -a $ADMINPW -U

echo $ADMINPW|kinit admin

ipa dnszone-add $ADDOMAIN --name-server=$ADSERVER \
  --admin-email="hostmaster@$ADDOMAIN" --force  \
  --forwarder=$ADSERVERIP --forward-policy=only

ipa trust-add $ADDOMAIN --admin Administrator --password

dig +nocomments +noquestion +nostats +nocmd SRV _ldap._tcp.$DOMAIN
dig +nocomments +noquestion +nostats +nocmd SRV _ldap._tcp.$ADDOMAIN

M1="\[realms\]"
M2="}"
A1="  auth_to_local =" 
A1="$A1 RULE:[1:\$1@\$0](^.\*@ADTESTDOM.COM$)s\/@ADTESTDOM.COM\/@adtestdom.com\/" 
sed -i "/$M1/,/$M2/ s/^\(.*}\)/$A1\n\1/" /etc/krb5.conf

M1="\[realms\]"
M2="}"
A1="  auth_to_local ="
A1="$A1 default"
sed -i "/$M1/,/$M2/ s/^\(.*}\)/$A1\n\1/" /etc/krb5.conf

M1="\[domain\/testrelm.com\]"
M2="\[sssd\]"
A1="subdomains_provider = ipa"
sed -i "/$M1/,/$M2/ s/^\(.*\[sssd\]\)/$A1\n\1/" /etc/sssd/sssd.conf

M1="\[sssd\]"
M2="\["
sed -i "/$M1/,/$M2/ s/\(services.*\)$/\1, pac/" /etc/sssd/sssd.conf

service sssd restart
service winbind restart
service smb restart

echo $ADMINPW|kinit admin

ipa group-add --desc='adtestdom.com adtestgroup1' adtestdom_adtestgroup1
ipa group-add --desc='adtestdom.com adtestgroup1 external' adtestdom_adtestgroup1_external --external
ipa group-add-member adtestdom_adtestgroup1 --groups=adtestdom_adtestgroup1_external
ipa group-add-member adtestdom_adtestgroup1_external --external "ADTESTDOM\adtestgroup1"

ipa-replica-prepare -p $ADMINPW --ip-address=$SLAVEIP $SLAVE_S.$DOMAIN

# slave
sed -i s/^nameserver/#nameserver/g /etc/resolv.conf
echo "nameserver $MASTERIP" >> /etc/resolv.conf
echo "nameserver $SLAVEIP" >> /etc/resolv.conf
cat /etc/resolv.conf

sftp root@$MASTERIP:/var/lib/ipa/replica-info-$SLAVE_S.$DOMAIN.gpg /dev/shm

ipa-replica-install -U --setup-dns --forwarder=$DNSFORWARD -w $ADMINPW -p $ADMINPW /dev/shm/replica-info-$SLAVE_S.$DOMAIN.gpg

# client
sed -i s/^nameserver/#nameserver/g /etc/resolv.conf
echo "nameserver $MASTERIP" >> /etc/resolv.conf
echo "nameserver $SLAVEIP" >> /etc/resolv.conf
cat /etc/resolv.conf

ipa-client-install -U --domain=$DOMAIN --realm=$RELM -p $ADMINID -w $ADMINPW --server=$MASTER_S.$DOMAIN

