###############################################################################
###### SSH
###############################################################################
### 1. Trusted AD user ssh using username without '@ad.domain' password/passwordless
Setup:
1. need non-Administrator AD user to exist.

Actions:
On IPA Master:
1. ssh -l aduser ipamaster.ipa.example.com
2. less /var/log/secure

Expected Results:
1. prompts for password and fails
2. should see errors like this at the end:

Oct 25 15:30:31 ipamaster sshd[10610]: Failed password for invalid user adtestuser1 from 192.168.122.61 port 39246 ssh2
Oct 25 15:30:37 ipamaster sshd[10610]: Failed password for invalid user adtestuser1 from 192.168.122.61 port 39246 ssh2
Oct 25 15:30:41 ipamaster sshd[10610]: Failed password for invalid user adtestuser1 from 192.168.122.61 port 39246 ssh2

Breakdown:

### 2. Trusted AD user ssh using username with 'aduser@ad.domain' passwordless
Setup:
1. need a non-Administrator AD user to exist.

Actions:
1. kinit aduser@AD.EXAMPLE.COM 
2. ssh -K -l aduser@AD.EXAMPLE.COM ipamaster.ipa.example.com

Expected Results:
1. changes kerberos user to the AD Trusted User
2. SSH into 

### 2.1 Trusted AD user ssh using username with 'aduser@AD.DOMAIN' passwordless

[root@rhel6-1 ~]# ssh -K -l adtestuser1@ADTESTDOM.COM rhel6-1.testrelm.com
adtestuser1@ADTESTDOM.COM@rhel6-1.testrelm.com's password: 
Last login: Thu Oct 25 15:34:00 2012 from rhel6-1.testrelm.com
id: cannot find name for group ID 1232801136

-sh-4.1$ exit
logout

[root@rhel6-1 ~]# tail -9 /var/log/secure
Oct 25 15:33:58 rhel6-1 sshd[10632]: Authorized to adtestuser1@adtestdom.com, krb5 principal adtestuser1@ADTESTDOM.COM (krb5_kuserok)
Oct 25 15:33:58 rhel6-1 sshd[10632]: Accepted gssapi-with-mic for adtestuser1@adtestdom.com from 192.168.122.61 port 39253 ssh2
Oct 25 15:34:00 rhel6-1 sshd[10632]: pam_unix(sshd:session): session opened for user adtestuser1@adtestdom.com by (uid=0)
Oct 25 15:34:38 rhel6-1 sshd[10632]: pam_unix(sshd:session): session closed for user adtestuser1@adtestdom.com
Oct 25 15:34:44 rhel6-1 sshd[10664]: pam_unix(sshd:auth): authentication failure; logname= uid=0 euid=0 tty=ssh ruser= rhost=rhel6-1.testrelm.com  user=adtestuser1@ADTESTDOM.COM
Oct 25 15:34:45 rhel6-1 sshd[10664]: pam_sss(sshd:auth): authentication success; logname= uid=0 euid=0 tty=ssh ruser= rhost=rhel6-1.testrelm.com user=adtestuser1@ADTESTDOM.COM
Oct 25 15:34:45 rhel6-1 sshd[10664]: Accepted password for adtestuser1@ADTESTDOM.COM from 192.168.122.61 port 39258 ssh2
Oct 25 15:34:46 rhel6-1 sshd[10664]: pam_unix(sshd:session): session opened for user adtestuser1@ADTESTDOM.COM by (uid=0)
Oct 25 15:35:38 rhel6-1 sshd[10664]: pam_unix(sshd:session): session closed for user adtestuser1@ADTESTDOM.COM

[WARN] Why can we not use GSSAPI auth with upper case user@AD.DOMAIN.COM?

### 3. Trusted AD user ssh to IPA machine with password without authenticating on AD

[root@rhel6-1 ~]# kdestroy

[root@rhel6-1 ~]# ssh -l adtestuser1@adtestdom.com rhel6-1.testrelm.com
adtestuser1@adtestdom.com@rhel6-1.testrelm.com's password: 
Last login: Thu Oct 25 15:34:46 2012 from rhel6-1.testrelm.com
id: cannot find name for group ID 1232801136

[PASS]

### 4. Trusted AD user authenticated on AD ssh as different AD user to IPA machine

[root@rhel6-1 ~]# kinit adtestuser1@ADTESTDOM.COM
Password for adtestuser1@ADTESTDOM.COM: 

[root@rhel6-1 ~]# klist
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: adtestuser1@ADTESTDOM.COM

Valid starting     Expires            Service principal
10/25/12 15:45:50  10/26/12 01:45:33  krbtgt/ADTESTDOM.COM@ADTESTDOM.COM
	renew until 10/26/12 15:45:50

[root@rhel6-1 ~]# ssh -l adtestuser2@adtestdom.com rhel6-1.testrelm.com
adtestuser2@adtestdom.com@rhel6-1.testrelm.com's password: 
Creating home directory for adtestuser2@adtestdom.com.
id: cannot find name for group ID 1232801138

-sh-4.1$ id
uid=1232801138(adtestuser2@adtestdom.com) gid=1232801138 groups=1232801138,1277200028(adtestdom_domain_users) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023

[PASS]

### 5. Trusted AD user authenticated on AD ssh passwordless to IPA machine

[root@rhel6-1 yum.local.d]# kinit admin
Password for admin@TESTRELM.COM:

[root@rhel6-1 yum.local.d]# kinit testuser1@ADTESTDOM.COM
Password for testuser1@ADTESTDOM.COM:

[root@rhel6-1 yum.local.d]# id
uid=0(root) gid=0(root) groups=0(root) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023

[root@rhel6-1 yum.local.d]# klist
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: testuser1@ADTESTDOM.COM

Valid starting     Expires            Service principal
10/23/12 12:28:31  10/23/12 22:28:22  krbtgt/ADTESTDOM.COM@ADTESTDOM.COM
    renew until 10/24/12 12:28:31

[root@rhel6-1 yum.local.d]# ssh -K -l testuser1@adtestdom.com rhel6-1
Last login: Tue Oct 23 12:28:04 2012 from rhel6-1.testrelm.com

[PASS]

### 6. Trusted AD user ssh and executes linux cmds, create, modify files.

[root@rhel6-1 ~]# kdestroy

[root@rhel6-1 ~]# kinit adtestuser1@ADTESTDOM.COM
Password for adtestuser1@ADTESTDOM.COM: 

[root@rhel6-1 ~]# klist
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: adtestuser1@ADTESTDOM.COM

Valid starting     Expires            Service principal
10/25/12 15:47:28  10/26/12 01:47:12  krbtgt/ADTESTDOM.COM@ADTESTDOM.COM
	renew until 10/26/12 15:47:28

[root@rhel6-1 ~]# ssh -l adtestuser1@adtestdom.com rhel6-1.testrelm.com
Last login: Thu Oct 25 15:44:57 2012 from rhel6-1.testrelm.com
id: cannot find name for group ID 1232801136

-sh-4.1$ ls -l
total 0

-sh-4.1$ pwd
/home/adtestdom.com/adtestuser1

-sh-4.1$ touch one

-sh-4.1$ cat one

-sh-4.1$ date > one

-sh-4.1$ cat one
Thu Oct 25 15:48:04 EDT 2012

-sh-4.1$ mkdir two

-sh-4.1$ cd two

-sh-4.1$ hostname > three

-sh-4.1$ ls
three

-sh-4.1$ cat three
rhel6-1.testrelm.com

-sh-4.1$ pwd
/home/adtestdom.com/adtestuser1/two

-sh-4.1$ ls -ldZ
drwxr-xr-x. adtestuser1@adtestdom.com 1232801136 unconfined_u:object_r:user_home_t:s0 .

[PASS]

### 7. New AD user ssh to IPA Server with password without authenticating on AD and execute linux cmds

> CREATE USER ON AD

[root@rhel6-1 ~]# ssh -l adtestuser4@adtestdom.com rhel6-1.testrelm.com
adtestuser4@adtestdom.com@rhel6-1.testrelm.com's password: 
Creating home directory for adtestuser4@adtestdom.com.
id: cannot find name for group ID 1232801140

[PASS]

### 8. New AD user authenticated on AD ssh to IPA Server passwordless and executes linux cmds

[root@rhel6-1 ~]# kinit adtestuser5@ADTESTDOM.COM
Password for adtestuser5@ADTESTDOM.COM: 

[root@rhel6-1 ~]# ssh -K -l adtestuser5@adtestdom.com rhel6-1.testrelm.com
Creating home directory for adtestuser5@adtestdom.com.
id: cannot find name for group ID 1232801141

-sh-4.1$ id
whoauid=1232801141(adtestuser5@adtestdom.com) gid=1232801141 groups=1232801141,1277200028(adtestdom_domain_users) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023

-sh-4.1$ whoami

adtestuser5@adtestdom.com
-sh-4.1$ 

[PASS]

### 9. Note UID, GID, home dir then delete AD user on AD while logged in to IPA, AD user create, modify files.

[root@rhel6-1 ~]# ssh -K -l adtestuser5@adtestdom.com rhel6-1.testrelm.com
Creating home directory for adtestuser5@adtestdom.com.
id: cannot find name for group ID 1232801141

-sh-4.1$ id
whoauid=1232801141(adtestuser5@adtestdom.com) gid=1232801141 groups=1232801141,1277200028(adtestdom_domain_users) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023

-sh-4.1$ whoami
adtestuser5@adtestdom.com

-sh-4.1$ pwd
/home/adtestdom.com/adtestuser5

-sh-4.1$ ls -ld .
drwxr-xr-x. 2 adtestuser5@adtestdom.com 1232801141 4096 Oct 25 15:53 .

Then on AD, delete user adtestuser5...

-sh-4.1$ id
uid=1232801141 gid=1232801141 groups=1232801141,1277200028(adtestdom_domain_users) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023

-sh-4.1$ id 
uid=1232801141 gid=1232801141 groups=1232801141,1277200028(adtestdom_domain_users) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023

-sh-4.1$ ls -ld .
drwxr-xr-x. 2 1232801141 1232801141 4096 Oct 25 15:53 .

-sh-4.1$ whoami
whoami: cannot find name for user ID 1232801141

-sh-4.1$ touch file1

-sh-4.1$ ls -l
total 0

-rw-r--r--. 1 1232801141 1232801141 0 Oct 25 17:13 file1

[WARN] is this expected? seems like it?  you're logged in with the uid already so 
you can access files with that uid ownership.

### 10. Re-create same AD user, re-login, check UID,GID, Old home directory/files access

-sh-4.1$ exit
logout
Connection to rhel6-1.testrelm.com closed.

[root@rhel6-1 ~]# service sssd stop
Stopping sssd:                                             [  OK  ]

[root@rhel6-1 ~]# rm -f /var/lib/sss/db/*
rm: cannot remove `/var/lib/sss/db/backup1': Is a directory

[root@rhel6-1 ~]# service sssd start
Starting sssd:                                             [  OK  ]

[root@rhel6-1 ~]# klist
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: adtestuser5@ADTESTDOM.COM

Valid starting     Expires            Service principal
10/25/12 15:52:31  10/26/12 01:52:15  krbtgt/ADTESTDOM.COM@ADTESTDOM.COM
	renew until 10/26/12 15:52:31
10/25/12 15:52:59  10/26/12 01:52:15  krbtgt/TESTRELM.COM@ADTESTDOM.COM
	renew until 10/26/12 15:52:31
10/25/12 15:53:18  10/26/12 01:52:15  host/rhel6-1.testrelm.com@TESTRELM.COM
	renew until 10/26/12 15:52:31

[root@rhel6-1 ~]# kdestroy

[root@rhel6-1 ~]# ssh -l adtestuser5@adtestdom.com rhel6-1.testrelm.com
adtestuser5@adtestdom.com@rhel6-1.testrelm.com's password: 
id: cannot find name for group ID 1232801142

-sh-4.1$ id
uid=1232801142(adtestuser5@adtestdom.com) gid=1232801142 groups=1232801142,1277200028(adtestdom_domain_users) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023

[WARN] I don't suppose there's a way around the scenario where the user still 
has access there before logout and re-login?  Otherwise, we have to wait for
the SSSD cache to clear?

### 11. AD user/admin executes 'passwd' cmd

-sh-4.1$ passwd
Changing password for user adtestuser5@adtestdom.com.
Current Password: 
passwd: Authentication token manipulation error

-sh-4.1$ exit
logout
Connection to rhel6-1.testrelm.com closed.

[root@rhel6-1 ~]# tail -3 /var/log/secure
Oct 25 17:22:28 rhel6-1 passwd: pam_unix(passwd:chauthtok): user "adtestuser5@adtestdom.com" does not exist in /etc/passwd
Oct 25 17:22:32 rhel6-1 passwd: pam_sss(passwd:chauthtok): Authentication failed for user adtestuser5@adtestdom.com: 4 (System error)
Oct 25 17:23:36 rhel6-1 sshd[11248]: pam_unix(sshd:session): session closed for user adtestuser5@adtestdom.com

[root@rhel6-1 ~]# kinit Administrator@ADTESTDOM.COM
Password for Administrator@ADTESTDOM.COM: 

[root@rhel6-1 ~]# passwd adtestuser5@adtestdom.com
Changing password for user adtestuser5@adtestdom.com.
passwd: Authentication token manipulation error

[root@rhel6-1 ~]# passwd adtestuser5@ADTESTDOM.COM
Changing password for user adtestuser5@ADTESTDOM.COM.
passwd: Authentication token manipulation error

[FAIL]  I would expect this to work but, I don't think this is a blocker.

https://bugzilla.redhat.com/show_bug.cgi?id=870238

### 12. AD user/admin executes 'su' to root

[root@rhel6-1 ~]# ssh -l adtestuser5@adtestdom.com rhel6-1.testrelm.com
adtestuser5@adtestdom.com@rhel6-1.testrelm.com's password: 
Permission denied, please try again.
adtestuser5@adtestdom.com@rhel6-1.testrelm.com's password: 
Last login: Thu Oct 25 17:22:14 2012 from rhel6-1.testrelm.com
id: cannot find name for group ID 1232801142

-sh-4.1$ su -
Password: 

[PASS]

### 13. AD user ssh between 2 IPA domain machines passwordless

[root@rhel6-1 ~]# ssh -l adtestuser5@adtestdom.com rhel6-3.testrelm.com
adtestuser5@adtestdom.com@rhel6-3.testrelm.com's password: 
Creating home directory for adtestuser5@adtestdom.com.
id: cannot find name for group ID 1232801142

-sh-4.1$ hostname
rhel6-3.testrelm.com

-sh-4.1$ kinit
Password for adtestuser5@ADTESTDOM.COM: 

-sh-4.1$ ssh -K rhel6-1.testrelm.com
Last login: Thu Oct 25 18:10:16 2012 from rhel6-1.testrelm.com
id: cannot find name for group ID 1232801142

-sh-4.1$ hostname
rhel6-1.testrelm.com

[PASS] - This required the patched version of sssd:
0:1.9.90-0.20121023.1813.git8662356.el6

### 14. AD user ssh between 2 IPA domain machines with password
-sh-4.1$ hostname
rhel6-1.testrelm.com

-sh-4.1$ kdestroy

-sh-4.1$ ssh rhel6-3.testrelm.com
adtestuser5@adtestdom.com@rhel6-3.testrelm.com's password: 
Last login: Thu Oct 25 18:17:07 2012 from 192.168.122.61
id: cannot find name for group ID 1232801142

-sh-4.1$ hostname
rhel6-3.testrelm.com

[PASS] - This required the patched version of sssd:
0:1.9.90-0.20121023.1813.git8662356.el6

### 15. AD user tries deleting trust from IPA server after ssh login

-sh-4.1$ kinit adtestuser5@ADTESTDOM.COM 
Password for adtestuser5@ADTESTDOM.COM: 

-sh-4.1$ ipa trust-del adtestdom.com
ipa: ERROR: cannot connect to Gettext('any of the configured servers', domain='ipa', localedir=None): https://rhel6-1.testrelm.com/ipa/xml, https://rhel6-2.testrelm.com/ipa/xml

[WARN] error here expected because only IPA admin has permission to run by default?

### 16. AD administrator deleting trust from IPA server after ssh login

-sh-4.1$ kinit Administrator@ADTESTDOM.COM
Password for Administrator@ADTESTDOM.COM: 

-sh-4.1$ ipa trust-del adtestdom.com
ipa: ERROR: cannot connect to Gettext('any of the configured servers', domain='ipa', localedir=None): https://rhel6-1.testrelm.com/ipa/xml, https://rhel6-2.testrelm.com/ipa/xml

[WARN] error here expected because only IPA admin has permission to run by default?

###############################################################################
###### NFS
###############################################################################
### 17. AD user NFS share access from windows client

[root@rhel6-1 ~]# service rpcbind restart
Stopping rpcbind:                                          [  OK  ]
Starting rpcbind:                                          [  OK  ]

[root@rhel6-1 ~]# service nfs restart
Shutting down NFS daemon:                                  [  OK  ]
Shutting down NFS mountd:                                  [  OK  ]
Shutting down NFS quotas:                                  [  OK  ]
Starting NFS services:                                     [  OK  ]
Starting NFS quotas:                                       [  OK  ]
Starting NFS mountd:                                       [  OK  ]
Starting NFS daemon:                                       [  OK  ]

[root@rhel6-1 ~]# exportfs -o rw *:/tmp 

[root@rhel6-1 ~]# exportfs 
/tmp          	<world>

[root@rhel6-1 ~]# showmount -e localhost
Export list for localhost:
/tmp *

On Windows Client:

> mount rhel6-1.testrelm.com:/tmp *
Z:

> z:

> dir
showed what is in /tmp on rhel6-1.testrelm.com.

[PASS]

### 18. AD user NFS share access from IPA client after ssh login

-sh-4.1$ hostname
rhel6-3.testrelm.com

-sh-4.1$ id
uid=1232801139(adtestuser3@adtestdom.com) gid=1232801139 groups=1232801139,1277200028(adtestdom_domain_users) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023

-sh-4.1$ klist
Ticket cache: FILE:/tmp/krb5cc_1232801139_PcW5lp
Default principal: adtestuser3@ADTESTDOM.COM

Valid starting     Expires            Service principal
10/26/12 15:03:50  10/27/12 01:03:00  krbtgt/ADTESTDOM.COM@ADTESTDOM.COM
	renew until 10/27/12 15:03:50

-sh-4.1$ mkdir /tmp/mount

-sh-4.1$ mount rhel6-1.testrelm.com:/tmp /tmp/mount
mount: only root can do that

[WARN] We are expecting this one to fail right?  Or was this supposed to be tested 
differently?

### 19. AD user unable to write to NFS share in ro mode, from windows client

[root@rhel6-1 tmp]# exportfs -ua
[root@rhel6-1 tmp]# exportfs -o ro *:/tmp
[root@rhel6-1 tmp]# exportfs
/tmp          	<world>
[root@rhel6-1 tmp]# exportfs -v
/tmp          	<world>(ro,wdelay,root_squash,no_subtree_check)

On Windows client as adtestuser3:

C:\> mount rhel6-1.testrelm.com:/tmp *
Z: is now successfully connected to rhel6-1.testrelm.com:/tmp
C:\>z:
Z:\> copy c:\Windows\win.ini z:\test_win.ini
The media is write protected.
        0 file(s) copied.

[PASS] failed to write as expected.

### 20. AD user unable to write to NFS share in ro mode, from IPA client

[root@rhel6-3 ~]# mount rhel6-1.testrelm.com:/tmp /mnt
[root@rhel6-3 ~]# cd /mnt
[root@rhel6-3 mnt]# touch one
touch: cannot touch `one': Read-only file system
[root@rhel6-3 ~]# ssh -l adtestuser3@adtestdom.com rhel6-3
adtestuser3@adtestdom.com@rhel6-3's password: 
Last login: Fri Oct 26 15:03:53 2012 from rhel6-1.testrelm.com
id: cannot find name for group ID 1232801139
-sh-4.1$ cd /mnt
-sh-4.1$ touch one
touch: cannot touch `one': Read-only file system

[PASS]

### 21. AD user unable to write to NFS share with restricted file permissions, from windows client
On IPA MASTER:

[root@rhel6-1 tmp]# exportfs -ua
[root@rhel6-1 tmp]# exportfs *:/tmp 
[root@rhel6-1 tmp]# rm -rf roottestdir/
[root@rhel6-1 tmp]# mkdir roottestdir/
[root@rhel6-1 tmp]# chmod 700 roottestdir/

On AD CLIENT:

c:\>umount z:
c:\>mount rhel6-1.testrelm.com:/tmp *
c:\>z:
z:\>cd roottestdir
Access is denied.

ON IPA MASTER:

[root@rhel6-1 tmp]# chmod 755 roottestdir/

On AD CLIENT:

z:\>cd roottestdir
z:\roottestdir>copy c:\Windows\win.ini z:\roottestdir\test_win.ini
The media is write protected.
        0 files(s) copied.

[PASS]

### 22. AD user unable to write to NFS share with restricted file permissions, from IPA client
[root@rhel6-1 tmp]# exportfs -ua
[root@rhel6-1 tmp]# exportfs *:/tmp 
[root@rhel6-1 tmp]# rm -rf roottestdir/
[root@rhel6-1 tmp]# mkdir roottestdir/
[root@rhel6-1 tmp]# chmod 700 roottestdir/
[root@rhel6-3 ~]# umount /mnt
[root@rhel6-3 ~]# mount rhel6-1.testrelm.com:/tmp /mnt
[root@rhel6-3 ~]# ssh -l adtestuser3@adtestdom.com rhel6-3
adtestuser3@adtestdom.com@rhel6-3's password: 
Last login: Fri Oct 26 15:46:27 2012 from rhel6-3.testrelm.com
id: cannot find name for group ID 1232801139


ON IPA MASTER:

[root@rhel6-1 tmp]# chmod 700 roottestdir/

ON IPA CLIENT:

-sh-4.1$ cd /mnt
-sh-4.1$ cd roottestdir/
-sh: cd: roottestdir/: Permission denied

Back on IPA MASTER:

[root@rhel6-1 tmp]# chmod 755 roottestdir/

On IPA CLIENT:

-sh-4.1$ pwd
/mnt
-sh-4.1$ ls -ld roottestdir/
drwxr-xr-x. 2 root root 4096 Oct 26 15:55 roottestdir/
-sh-4.1$ cd roottestdir/
-sh-4.1$ touch one
touch: cannot touch `one': Read-only file system

[PASS]

### 23. Using NFS all_squash option for share
ON IPA MASTER:

[root@rhel6-1 tmp]# exportfs -ua
[root@rhel6-1 tmp]# exportfs -o all_squash,rw *:/tmp

ON IPA CLIENT:

[root@rhel6-3 ~]# umount /mnt
[root@rhel6-3 ~]# mount rhel6-1.testrelm.com:/tmp /mnt
[root@rhel6-3 ~]# ssh -l adtestuser3@adtestdom.com rhel6-3
adtestuser3@adtestdom.com@rhel6-3's password: 
Last login: Fri Oct 26 16:01:17 2012 from rhel6-3.testrelm.com
id: cannot find name for group ID 1232801139
-sh-4.1$ cd /mnt/
-sh-4.1$ touch one
-sh-4.1$ ls -ld one
-rw-r--r--. 1 nfsnobody nfsnobody 0 Oct 26 16:09 one

ON AD CLIENT:

c:\>umount z:
c:\>mount rhel6-1.testrelm.com:/tmp *
c:\>z:
z:\>copy c:\windows\win.ini z:\tmp
        1 file(s) copied.

ON IPA MASTER:

[root@rhel6-1 tmp]# pwd
/tmp
[root@rhel6-1 tmp]# ls -ld one two
-rw-r--r--. 1 nfsnobody nfsnobody  0 Oct 26 16:09 one
-rwxr-xr-x. 1 nfsnobody nfsnobody 92 Jun 10  2009 two

[PASS]

###############################################################################
###### Console
###############################################################################
### 24. AD user login to IPA machine console

Red Hat Enterprise Linux Server release 6.4 Beta (Santiago)
Kernel 2.6.32-335.el6.x86_64 on an x86_64

rhel6-3.testrelm.com login: ADTESTDOM.COM
Password: 
Login incorrect

login: ADTESTDOM\adtestuser1
Password: 
Login incorrect

login: ADTESTDOM.COM\adtestuser1
Password: 
Creating home directory for ADTESTDOM.COM\adtestuser1.
id: cannot find name for group ID 1232801136
-sh-4.1$ ls
-sh-4.1$ pwd
/home/adtestdom.com/adtestuser1
-sh-4.1$ 

[WARN] Hit the @ issue with mingetty and Not able to use NetBIOS name.

### 25. AD user ssh to another IPA machine passwordless after console access

rhel6-3.testrelm.com login: ADTESTDOM.COM\adtestuser1
Password: 
Last login: Fri Oct 26 16:26:36 on ttyS0
id: cannot find name for group ID 1232801136

-sh-4.1$ klist
Ticket cache: FILE:/tmp/krb5cc_1232801136_pvo7kJ
Default principal: adtestuser1@ADTESTDOM.COM

Valid starting     Expires            Service principal
10/26/12 16:39:57  10/27/12 02:39:07  krbtgt/ADTESTDOM.COM@ADTESTDOM.COM
	renew until 10/27/12 16:39:57

-sh-4.1$ ssh -K -l adtestuser1@adtestdom.com rhel6-1.testrelm.com
Last login: Thu Oct 25 15:47:51 2012 from rhel6-1.testrelm.com
id: cannot find name for group ID 1232801136

-sh-4.1$ 

[PASS]

### 26. AD user mounts NFS share after console access

-sh-4.1$ hostname
rhel6-3.testrelm.com
-sh-4.1$ mkdir /tmp/mnt
-sh-4.1$ mount rhel6-1.testrelm.com:/tmp /tmp/mnt
mount: only root can do that

[PASS] failure expected

### 27. AD user login passwordless ssh as well as console, create and modify files.

rhel6-3.testrelm.com login: ADTESTDOM.COM\adtestuser1
Password: 
Last login: Fri Oct 26 16:39:58 on ttyS0
id: cannot find name for group ID 1232801136
-sh-4.1$ kinit adtestuser1@ADTESTDOM.COM
Password for adtestuser1@ADTESTDOM.COM: 
-sh-4.1$ ssh -K -l adtestuser1@adtestdom.com rhel6-1.testrelm.com
Last login: Fri Oct 26 16:41:39 2012 from 192.168.122.63
id: cannot find name for group ID 1232801136
-sh-4.1$ touch myfile1
-sh-4.1$ ls -l
total 8
-rw-r--r--. 1 adtestuser1@adtestdom.com 1232801136    0 Oct 26 16:49 myfile1
-rw-r--r--. 1 adtestuser1@adtestdom.com 1232801136   29 Oct 25 15:48 one
drwxr-xr-x. 2 adtestuser1@adtestdom.com 1232801136 4096 Oct 25 15:48 two
-sh-4.1$ date > myfile1 
-sh-4.1$ cat myfile1 
Fri Oct 26 16:50:01 EDT 2012
-sh-4.1$ hostname
rhel6-1.testrelm.com
-sh-4.1$ exit
logout
Connection to rhel6-1.testrelm.com closed.
-sh-4.1$ touch file2
-sh-4.1$ ls
file2
-sh-4.1$ ls -l
date total 0
-rw-r--r--. 1 adtestuser1@adtestdom.com 1232801136 0 Oct 26 16:50 file2
-sh-4.1$ date > file2
-sh-4.1$ cat file2
Fri Oct 26 16:50:29 EDT 2012
-sh-4.1$ 

[PASS]

###############################################################################
###### IPA Winsync
###############################################################################
### Establish Synchronization Agreements with the same AD server
### 28. Getent passwd output for 'aduser@ad.domain' (adtrust) and aduser (winsync)
### 29. Existing trusted AD user login passwordless ssh from windows client 
    # and same AD synced user ssh login with password after password change
### 30. Create new trusted AD user, login passwordless ssh from windows client 
    # and same AD synced user ssh login with password

###############################################################################
###### HBAC
###############################################################################
### 31. Sshd HBAC allow rule for AD user, login as AD trusted user

Adding AD user to an hbac rule must be done by using nested external group.

This one is a negative test.  

[root@rhel6-1 sssd]#  ipa hbacrule-add-user hbactest --users="adtestuser2@adtestdom.com"
  Rule name: hbactest
  Description: test
  Enabled: TRUE
  User Groups: adtestdom_adtestgroup1
  Hosts: rhel6-1.testrelm.com
  Services: sshd
  Failed users/groups: 
    member user: adtestuser2@adtestdom.com: no such entry
    member group: 
-------------------------
Number of members added 0
-------------------------

[root@rhel6-1 sssd]# echo $?
1

[PASS] --users expects an IPA user that is an actual DN in ldap.  Not an external.  That is
not supported in hbacrule.

### 32. Sshd HBAC deny rule for AD user, login as AD trusted user

There are no explicit deny rules here but, we can deny via absense of a user.
So create a rule that does not contain a user to test with.  That will deny the user access.

[root@rhel6-1 sssd]# echo "password" | ipa user-add ipauser1 --first=f --last=l --password
---------------------
Added user "ipauser1"
---------------------
  User login: ipauser1
  First name: f
  Last name: l
  Full name: f l
  Display name: f l
  Initials: fl
  Home directory: /home/ipauser1
  GECOS field: f l
  Login shell: /bin/sh
  Kerberos principal: ipauser1@TESTRELM.COM
  Email address: ipauser1@testrelm.com
  UID: 1277200046
  GID: 1277200046
  Password: True
  Kerberos keys available: True

[root@rhel6-1 sssd]# echo -en "password\nPassw0rd1\nPassw0rd1"| kinit ipauser1
Password for ipauser1@TESTRELM.COM: 
Password expired.  You must change it now.
Enter new password: 
Enter it again: 

[root@rhel6-1 sssd]# echo Secret123|kinit admin
Password for admin@TESTRELM.COM: 

[root@rhel6-1 sssd]# ipa group-add-member --users=ipauser1
Group name: ipagroup1
  Group name: ipagroup1
  Description: ipagroup1
  GID: 1277200047
  Member users: ipauser1
-------------------------
Number of members added 1
-------------------------

# Note group above not actually needed

[root@rhel6-1 sssd]# ipa hbacrule-add hbactestipa
-----------------------------
Added HBAC rule "hbactestipa"
-----------------------------
  Rule name: hbactestipa
  Enabled: TRUE

[root@rhel6-1 sssd]# ipa hbacrule-add-service hbactestipa --hbacsvcs=sshd
  Rule name: hbactestipa
  Enabled: TRUE
  Services: sshd
-------------------------
Number of members added 1
-------------------------

[root@rhel6-1 sssd]# ipa hbacrule-add-host hbactestipa --hosts=rhel6-1.testrelm.com
  Rule name: hbactestipa
  Enabled: TRUE
  Hosts: rhel6-1.testrelm.com
  Services: sshd
-------------------------
Number of members added 1
-------------------------

[root@rhel6-1 sssd]# ipa hbacrule-add-user hbactestipa --users=ipauser1
  Rule name: hbactestipa
  Enabled: TRUE
  Users: ipauser1
  Hosts: rhel6-1.testrelm.com
  Services: sshd
-------------------------
Number of members added 1
-------------------------

[root@rhel6-1 sssd]# ipa hbacrule-disable allow_all
------------------------------
Disabled HBAC rule "allow_all"
------------------------------

[root@rhel6-1 sssd]# kinit adtestuser2@ADTESTDOM.COM
Password for adtestuser2@ADTESTDOM.COM: 

[root@rhel6-1 sssd]# klist
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: adtestuser2@ADTESTDOM.COM

Valid starting     Expires            Service principal
10/30/12 13:28:59  10/30/12 23:28:52  krbtgt/ADTESTDOM.COM@ADTESTDOM.COM
	renew until 10/31/12 13:28:59

[root@rhel6-1 sssd]# ssh -K -l adtestuser2@adtestdom.com rhel6-1
Connection closed by UNKNOWN

[root@rhel6-1 sssd]# tail -3 /var/log/secure
Oct 30 13:29:21 rhel6-1 sshd[30255]: Authorized to adtestuser2@adtestdom.com, krb5 principal adtestuser2@ADTESTDOM.COM (krb5_kuserok)
Oct 30 13:29:22 rhel6-1 sshd[30255]: pam_sss(sshd:account): Access denied for user adtestuser2@adtestdom.com: 6 (Permission denied)
Oct 30 13:29:22 rhel6-1 sshd[30256]: fatal: Access denied for user adtestuser2@adtestdom.com by PAM account configuration

[PASS] failure expected.

### 33. Sshd HBAC allow rule for AD user group, trusted AD member user
[root@rhel6-1 sssd]# ipa hbacrule-add --desc=test hbactest
--------------------------
Added HBAC rule "hbactest"
--------------------------
  Rule name: hbactest
  Description: test
  Enabled: TRUE

[root@rhel6-1 sssd]# ipa hbacrule-add-host hbactest --hosts=rhel6-1.testrelm.com
  Rule name: hbactest
  Description: test
  Enabled: TRUE
  Hosts: rhel6-1.testrelm.com
-------------------------
Number of members added 1
-------------------------

[root@rhel6-1 sssd]# ipa hbacrule-add-service hbactest --hbacsvcs=sshd
  Rule name: hbactest
  Description: test
  Enabled: TRUE
  Hosts: rhel6-1.testrelm.com
  Services: sshd
-------------------------
Number of members added 1
-------------------------

[root@rhel6-1 sssd]# ipa hbacrule-add-user hbactest --groups=adtestdom_adtestgroup1
  Rule name: hbactest
  Description: test
  Enabled: TRUE
  User Groups: adtestdom_adtestgroup1
  Hosts: rhel6-1.testrelm.com
  Services: sshd
-------------------------
Number of members added 1
-------------------------

[root@rhel6-1 sssd]# ipa group-show adtestdom_adtestgroup1
  Group name: adtestdom_adtestgroup1
  Description: adtestdom.com adtestgroup1
  GID: 1277200040
  Member groups: adtestdom_adtestgroup1_external
  Member of Sudo rule: testrule
  Member of HBAC rule: hbactest

[root@rhel6-1 sssd]# ipa group-show adtestdom_adtestgroup1_external
  Group name: adtestdom_adtestgroup1_external
  Description: adtestdom.com adtestgroup1 external
  Member of groups: adtestdom_adtestgroup1
  Indirect Member of Sudo rule: testrule
  Indirect Member of HBAC rule: hbactest
  External member: S-1-5-21-1246088475-3077293710-2580964704-1135

[root@rhel6-1 sssd]# wbinfo -n "ADTESTDOM\adtestgroup1"
S-1-5-21-1246088475-3077293710-2580964704-1135 SID_DOM_GROUP (2)
[root@rhel6-1 sssd]# 

[root@rhel6-1 sssd]# ipa hbacrule-disable allow_all
------------------------------
Disabled HBAC rule "allow_all"
------------------------------

[root@rhel6-1 sssd]# ssh -l adtestuser1@adtestdom.com rhel6-1
adtestuser1@adtestdom.com@rhel6-1's password: 
Connection closed by UNKNOWN

[FAIL] this should work.  BZ previously opened for this issue:

https://bugzilla.redhat.com/show_bug.cgi?id=869678

### 34. Sshd HBAC deny rule for AD user group, trusted AD member user

There is no deny specifically.  Must be done by leaving a user out of a group.

So, using previously created group rule, we test with a different user.

[root@rhel6-1 sssd]# kinit adtestuser3@ADTESTDOM.COM
Password for adtestuser3@ADTESTDOM.COM: 

[root@rhel6-1 sssd]# klist
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: adtestuser3@ADTESTDOM.COM

Valid starting     Expires            Service principal
10/30/12 13:33:57  10/30/12 23:33:51  krbtgt/ADTESTDOM.COM@ADTESTDOM.COM
	renew until 10/31/12 13:33:57

[root@rhel6-1 sssd]# ssh -K -l adtestuser3@adtestdom.com rhel6-1
Connection closed by UNKNOWN

[root@rhel6-1 sssd]# tail -3 /var/log/secure
Oct 30 13:34:21 rhel6-1 sshd[30291]: Authorized to adtestuser3@adtestdom.com, krb5 principal adtestuser3@ADTESTDOM.COM (krb5_kuserok)
Oct 30 13:34:21 rhel6-1 sshd[30291]: pam_sss(sshd:account): Access denied for user adtestuser3@adtestdom.com: 6 (Permission denied)
Oct 30 13:34:21 rhel6-1 sshd[30292]: fatal: Access denied for user adtestuser3@adtestdom.com by PAM account configuration

[PASS]

### 35. Console HBAC allow rule for AD user, login as AD trusted user

Ok, had to manually run the VM to get this to work.  Otherwise, using user@domain with the
default settings on my KVM host (my desktop) was a problem.  The device settings for the
console or serial device were causing @ to act like kill/delete.  So typing user@domain would
delete the user part before @ leaving only domain.

yum install tunctl
tunctl -u `whoami` -t vnet2
ip link set vnet2 up
brctl addif virbr0 vnet2

Most of that I got from different pages showing /etc/qemu-ifup

qemu-kvm -boot c -vga std -m 1024 -smp 1 -drive file=/data/VirtualMachines/rhel6-3.img,if=none,id=drive-virtio-disk0,format=qcow2 -device virtio-blk-pci,bus=pci.0,addr=0x4,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -net nic,macaddr=52:54:00:50:b4:06 -net tap,ifname=vnet2,script=no

Then on guest,

setenforce 0

Then disable hbac allow_all on master:

[root@rhel6-1 ~]# ipa hbacrule-disable allow_all
------------------------------
Disabled HBAC rule "allow_all"
------------------------------

This one will not work because you cannot explicitly add an AD fully qualified user to an HBAC rule.
You must add the AD group to an IPA group and use that.  This one handled from the HBAC user add 
above.

### 36. Console HBAC deny rule for AD user, login as AD trusted user

There is no deny specifically.  Must be done by leaving a user out of a group.

So, using previously created group rule, we test with a different user.

Try to login to console with adtestuser2@adtestdom.com.  This failed:

[root@rhel6-3 sssd]# tail -4 /var/log/secure
Oct 30 21:31:06 rhel6-3 login: pam_unix(login:auth): authentication failure; logname=LOGIN uid=0 euid=0 tty=tty1 ruser= rhost=  user=adtestuser2@adtestdom.com
Oct 30 21:31:07 rhel6-3 login: pam_sss(login:auth): authentication success; logname=LOGIN uid=0 euid=0 tty=tty1 ruser= rhost= user=adtestuser2@adtestdom.com
Oct 30 21:31:07 rhel6-3 login: pam_sss(login:account): Access denied for user adtestuser2@adtestdom.com: 6 (Permission denied)
Oct 30 21:31:07 rhel6-3 login: Permission denied

[PASS] it failed as expected.

### 37. Console HBAC allow rule for AD user group, login as AD trusted user

console login attempt for adtestuser1@adtestdom.com failed.

[FAIL] this should work.  BZ previously opened for this issue:

https://bugzilla.redhat.com/show_bug.cgi?id=869678

### 38. Console HBAC deny rule for AD user group, login as AD trusted user

There is no explicit deny.  It's handled by leaving a user out of a group.

So here we just test with a different user:

[root@rhel6-3 sssd]# tail -4 /var/log/secure
Oct 30 21:35:58 rhel6-3 login: pam_unix(login:auth): authentication failure; logname=LOGIN uid=0 euid=0 tty=tty1 ruser= rhost=  user=adtestuser3@adtestdom.com
Oct 30 21:35:59 rhel6-3 login: pam_sss(login:auth): authentication success; logname=LOGIN uid=0 euid=0 tty=tty1 ruser= rhost= user=adtestuser3@adtestdom.com
Oct 30 21:35:59 rhel6-3 login: pam_sss(login:account): Access denied for user adtestuser3@adtestdom.com: 6 (Permission denied)
Oct 30 21:35:59 rhel6-3 login: Permission denied

[PASS] failed as expected.

###############################################################################
###### SUDO
###############################################################################
### 39. Allow sudorule for AD user

[root@rhel6-1 ~]# wbinfo -n "ADTESTDOM\adtestuser1"
S-1-5-21-1246088475-3077293710-2580964704-1136 SID_USER (1)

[root@rhel6-1 ~]# ipa sudorule-add-user testrule --users=S-1-5-21-1246088475-3077293710-2580964704-1136
  Rule name: testrule
  Enabled: TRUE
  Host category: all
  Command category: all
  RunAs User category: all
  RunAs Group category: all
  External User: s-1-5-21-1246088475-3077293710-2580964704-1136
-------------------------
Number of members added 1
-------------------------

[root@rhel6-1 ~]#  ipa sudorule-add-user testrule --users=adtestuser1@adtestdom.com
ipa: ERROR: invalid 'user': may only include letters, numbers, _, -, . and $

[root@rhel6-1 ~]# su - adtestuser1@ADTESTDOM.COM
id: cannot find name for group ID 1232801136
-sh-4.1$ sudo id

We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.
    
[sudo] password for adtestuser1@adtestdom.com: 
adtestuser1@adtestdom.com is not in the sudoers file.  This incident will be reported.

[FAIL] Need to know how to do this or if it's just not possible.  How do I define the user?

Opened BZ: https://bugzilla.redhat.com/show_bug.cgi?id=871208
    
### 40. Deny sudorule for AD user

No deny rules.  Have to test failure by defining a command list and trying a command not on that list

### 41. Allow sudorule for AD user group
[root@rhel6-1 ~]# ipa sudorule-remove-user testrule --users=S-1-5-21-1246088475-3077293710-2580964704-1136
  Rule name: testrule
  Enabled: TRUE
  Host category: all
  Command category: all
  RunAs User category: all
  RunAs Group category: all
  External User: 
---------------------------
Number of members removed 1
---------------------------

[root@rhel6-1 ~]#  ipa sudorule-add-user testrule --groups=adtestdom_adtestgroup1
  Rule name: testrule
  Enabled: TRUE
  Host category: all
  Command category: all
  RunAs User category: all
  RunAs Group category: all
  User Groups: adtestdom_adtestgroup1
-------------------------
Number of members added 1
-------------------------

[root@rhel6-1 ~]# ssh -l adtestuser1@adtestdom.com rhel6-1.testrelm.com
adtestuser1@adtestdom.com@rhel6-1.testrelm.com's password: 
Last login: Fri Oct 26 16:49:38 2012 from 192.168.122.63
id: cannot find name for group ID 1232801136

-sh-4.1$ sudo id
[sudo] password for adtestuser1@adtestdom.com: 
adtestuser1@adtestdom.com is not in the sudoers file.  This incident will be reported.

[FAIL] need help troubleshooting this one.

opened BZ:  https://bugzilla.redhat.com/show_bug.cgi?id=871160

### 42. Deny sudorule for AD user group

No deny rules.  Have to test failure by defining a command list and trying a command not on that list

###############################################################################
###### CIFS
###############################################################################
### 43. AD user access CIFS writable share
[root@rhel6-1 ~]# net conf addshare test /tmp
[root@rhel6-1 ~]# net conf setparm test 'read only' 'no'
[root@rhel6-1 ~]# wbinfo -n "ADTESTDOM\administrator"
S-1-5-21-1246088475-3077293710-2580964704-500 SID_USER (1)
[root@rhel6-1 ~]# net conf setparm test 'valid users'  S-1-5-21-1246088475-3077293710-2580964704-500
[root@rhel6-1 ~]# net conf list
[global]
	workgroup = TESTRELM
	realm = TESTRELM.COM
	kerberos method = dedicated keytab
	dedicated keytab file = FILE:/etc/samba/samba.keytab
	create krb5 conf = no
	security = user
	domain master = yes
	domain logons = yes
	log level = 1
	max log size = 100000
	log file = /var/log/samba/log.%m
	passdb backend = ipasam:ldapi://%2fvar%2frun%2fslapd-TESTRELM-COM.socket
	disable spoolss = yes
	ldapsam:trusted = yes
	ldap ssl = off
	ldap suffix = dc=testrelm,dc=com
	ldap user suffix = cn=users,cn=accounts
	ldap group suffix = cn=groups,cn=accounts
	ldap machine suffix = cn=computers,cn=accounts
	rpc_server:epmapper = external
	rpc_server:lsarpc = external
	rpc_server:lsass = external
	rpc_server:lsasd = external
	rpc_server:samr = external
	rpc_server:netlogon = external
	rpc_server:tcpip = yes
	rpc_daemon:epmd = fork
	rpc_daemon:lsasd = fork

[test]
	path = /tmp
	guest ok = no
	read only = no
	valid users = S-1-5-21-1246088475-3077293710-2580964704-500

Now, I go to AD server (could have used client but, I just picked a window) and run cmd prompt:

C:\Users\Administrator>net use * \\rhel6-1.testrelm.com\test
Drive X: is now connected to \\rhel6-1.testrelm.com\test.

The command completed successfully
...

Above typed, not cut and pasted...

[PASS]

### 44. AD user access CIFS share with writeable no

[root@rhel6-1 ~]# net conf setparm test 'read only' 'yes'
[root@rhel6-1 ~]# net conf list
[global]
	workgroup = TESTRELM
	realm = TESTRELM.COM
	kerberos method = dedicated keytab
	dedicated keytab file = FILE:/etc/samba/samba.keytab
	create krb5 conf = no
	security = user
	domain master = yes
	domain logons = yes
	log level = 1
	max log size = 100000
	log file = /var/log/samba/log.%m
	passdb backend = ipasam:ldapi://%2fvar%2frun%2fslapd-TESTRELM-COM.socket
	disable spoolss = yes
	ldapsam:trusted = yes
	ldap ssl = off
	ldap suffix = dc=testrelm,dc=com
	ldap user suffix = cn=users,cn=accounts
	ldap group suffix = cn=groups,cn=accounts
	ldap machine suffix = cn=computers,cn=accounts
	rpc_server:epmapper = external
	rpc_server:lsarpc = external
	rpc_server:lsass = external
	rpc_server:lsasd = external
	rpc_server:samr = external
	rpc_server:netlogon = external
	rpc_server:tcpip = yes
	rpc_daemon:epmd = fork
	rpc_daemon:lsasd = fork

[test]
	path = /tmp
	guest ok = no
	valid users = S-1-5-21-1246088475-3077293710-2580964704-500
	read only = yes


Then on AD server :

z:\>copy c:\Windows\system.ini testini2.ini
        1 file(s) copied.

That shouldn't have happened?

[FAIL] What did I miss on this one?   A config on CIFS server side?

###############################################################################
###### HTTP
###############################################################################
### 45. Open IPA UI from windows client using FireFox

Opened and logged in with admin

[PASS]

### 46. Open IPA UI from windows client using IE

Opened and logged in with admin.  Had some issues with the page.  Had to kill 
the tab and log in again.

[PASS]  Although seems to fail first time accessing it with IE, I suspect that's 
related to the new secured site stuff that is apparently installed/configured now
by default?


### 47. Open IPA UI from windows client using Chrome

Not supported
