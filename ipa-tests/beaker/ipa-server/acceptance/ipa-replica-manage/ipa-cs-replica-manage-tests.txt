Hi,

Please review ipa-csreplica-manage test plan scenarios. I'm sure, this is not an exhaustive set, but I hope a manageable set of tests with 5 different hosts.

All suggestions/corrections welcome.


Test Env:
---------

1] Create Master (neptune)
1.1] Create replica files for Replica-1(mars) and Replica-2(silverbolt). And scp them to respective machines.

2] On Replica-1: Do a replica install *without* '--setup-ca' 

3] On Replica-2: Do a replica install with '--setup-ca' 
3.1] Generate a replica file on Replica-2 for Replica-3(uranus)

4] On Replica-3: Do a replica install with '--setup-ca'
4.1] Generate a replica file on Replica-3 for Replica-4(autumn)

5] On Replica-4:  Do a replica install with '--setup-ca'

Initial topology:
-----------------

          .--------------------.
          | Master(neptune)    |
          '--------------------'
               /     \
              /       \
             /         \
.-----------v-----.   .-v---------------------.
| Replica-1(mars) |   | Replica-2(silverbolt) |
| (w/o - CA)      |   | (with-CA)             |
'-----------------'   '-----------------------'
                               \
                                \
                           .-----v-------------.
                           | Replica-3(uranus) |
                           | (with-CA)         |
                           '-------------------'
                                /
                               /
               .--------------v----.
               | Replica-4(autumn) |
               | (with-CA)         |
               '-------------------'




list:
-----

1] icarm_list_positive_001 -- list all the servers  [# ipa-csreplica-manage list -p Secret123] -- run this on Master
2] icarm_list_positive_002 -- list the cs-replica agreements of Replica-1 [#ipa-csreplica-manage list -p Secret123 Replica-1] -- run this on Master
	+ NOTE: Replica-1 does not have CA configured, and it should be stated so)
3] icarm_list_positive_003 -- list the  cs-replica agreements of Replica-2 [#ipa-csreplica-manage list -p Secret123 Replica-2] -- run this on Replica-2
4] icarm_list_negative_001 -- look for a cs-replica agreement for a /non-existent/ host [# ipa-csreplica-manage list -p Secret123 Replica-4] -- run this on a Replica-1(which does not have CA configured)



connect:
--------
1] icarm_connect_positive_001 -- Connect Replica-2 with Replica-4 [as no prior explicit replication agreement exists between them]
2] icarm_connect_positive_002 -- Verify cs-replication is working between Replica2 and Replica-4 [by adding a test principal on Replica-2, and noticing if it reflects in the Replica-4]
	+ On Replica-2:  
		- $ cd /var/tmp/foobar ; certutil -N -d .
		- $ cat /dev/urandom | certutil -R -s "cn=silverbolt.lab.eng.pnq.redhat.com, O=LAB.ENG.PNQ.REDHAT.COM" -p "9323" -o test1.req -d . -a 
		- $ ipa-cert-request --principal=ABC/`hostname` test1.csr --add  # Note the serial no.
		- Let's list the issued cert : $ ipa cert-show 15
	+ On Replica-4(also, let's list the cert to ensure it's replicated):
		- $ ipa cert-show 15

[NOTES from Rob:  To really test this you should shut down replica 3 before adding the cert. This way you can be sure that the replication is happening over the 2->4 link and not the 2->3->4 link.]

3] icarm_connect_negative_001 -- Purposefully try to connect Replica-2 with Replica-3  [where a cs-replication agreement between both /already/ exists]



disconnect:
-----------
1] icarm_disconnect_positive_001 -- Disconnect cs-replication between Replica-2 and Replica-3
	+ Replication agreement between both should be disconnected successfully

[NOTES from Rob: I'd test adding records again here to be sure that 2->4 still continues to work.]

2] icarm_disconnect_positive_001 -- Verify cs-replication is truly disconnected between Replica-2 and Replica-3
	+ Add a couple of test service principals(using 'ipa-cert-request') on Replica-2 
	+ List('ipa cert-show') the details of a particular cert on Replica-2
	+ Wait 2 minutes, now, list('ipa cert-show') for the same cert as above on Replica-3 . Expected: cert data displayed on Replica-2 and Replica-3 should *not* match.
3] icarm_disconnect_negative_001 -- Purposefully try to disconnect an already disconnected cs-replication agreement between Replica-2 and Replica-3



re-initialize:
--------------
1] icarm_re-initialize_positive_001 -- Re-initialize cs-replication between Replica-2 and Replica-3
	+ Remove a couple of principals from Replica-3 to make the ldapdb corrupt; or delete a few ldap entries
	+ Now, issue a re-intialize on Replica-3 : $ ipa-csreplica-manage re-initialize --from Replica-2

2]  icarm_re-initialize_positive_002 -- Ensure re-initialization(from Replica-2) is successful on Replica-3
	+ Do an 'ipa cert-show' for a particular cert no Replica-2 
	+ And, do the same 'ipa cert-show' for the same serial no. as above on Replica-3
	+ The data and their checksums should match.	 

3] icarm_re-initialize_positive_003 -- Re-initialize cs-replication between Replica-3 and Replica-4
4] icarm_re-initialize_negative_001 -- Purposefully re-initialize cs-replication between Replica-2 and Replica-3 [which already /was/ re-initialized]



force-sync:
-----------
1] icarm_forcesync_positive_001 -- Force sync Replica-4 with Replica-3
	+ Take down network on Replica-4 machine for a few minutes
	+ Add a few test service principal entries on Replica-3
	+ Bring up n/w on Replica-4
	+ Do a force-sync on Replica-4 from Replica-3	
	
2] icarm_forcesync_negative_001 -- Purposefully force sync Replica-4 with Replica-3 [which already /was/ force-synced]
    [Notes from Rob -- This is a no-op test (not a negative, necessarily)
3] icarm_forcesync_negative_002 -- Force sync Replica-4 with a replica(Replica-1)  which /does not/ have a CA configured



del:
----
1] icarm_del_positive_001 - Delete cs-replication agreement and data on Replica-4
- icarm_del_negative_001 - Purposefully delete cs-replication agreement and data on Re]plica-4 [which already /was/ deleted previously]
2] icarm_del_negative_002 - Add(re-create) the Deleted Replica-4(w/ an agreement w/ Replica-3) without restarting Replica-3 
 	+ Expected: Replication should fail
3] icarm_del_negative_003 - Delete a non-existent cs-replica on Replica-1


