## Prerequisites to execute ipa-winsync tests. ##
# Follow these steps before starting the automatic tests
# For a complete detailed How To please check Setup_Doc file

1. Setup AD server if it does not already exist

2. While configuring AD Install DNS and add a conditional forwarder for "testrelm.com". Make sure IPA server is resolvable from AD server.

* Adding a conditional forwarder on the AD side

    Open Start->Administrative Tools->DNS
    make a right-click on 'Conditional Forwarders' in the left column of the window
    select 'New Conditional Forwerder...'
    add the DNS domain name of your IPA domain name "testrelm.com" and the IP adresses of one or more DNS servers i.e. the IPA server IP 

To test the new configuration you can try to ping the IPA server again from AD. It might be necessary to call 'ipconfig /flushdns' to removed any cached results.

Alternatively you can use command line utility dnscmd to configure the forwarder:

    Open Start -> Command Prompt
    Enter: dnscmd 127.0.0.1 /ZoneAdd IPA.Domain /Forwarder IP.AD.DR.ESS 

The command should report that zone IPA.Domain was successfully added. 

3. Fill-up the AD details in Config file placed in this directory

4. From AD copy the cert in the current directory replacing cert file "ADcert.cer"

5. Make IPA CA trusted by importing IPA cert in the AD server's database. Follow the steps below.
 
 a. Copy the cert file /etc/ipa/ca.crt to a location in AD server

 b. Download passync from below link on to the AD server
    https://wiki.idm.lab.bos.redhat.com/share/builds/components/winsync/passsync/20100512.1/release/

 c. Run it and provide the following values

    Hostname: <IPA server name>
    Port: 636
    Username: uid=passsync,cn=sysaccounts,cn=etc,dc=testrelm,dc=com
    Password: password
    Cert Token: Secret123
    search base: cn=users,cn=accounts,dc=testrelm,dc=com

 d. Download freeSSHd from the link below or use the one in the current directory
    http://www.freesshd.com/freeSSHd.exe
    # Note : Steps e and f are not required to be performed for automation

  i. While installing freesSSHd on the AD server, take all the default settings except for using it as a service.
 ii. Run the FreeSSHd shortcut from the desktop and configure and start the server

iii. Add user "administrator" from the "Users" tab and allow it to have SSH cmd line access.

 iv. Test the administrator ssh login from a linux machine

  v. Next on the AD server open FreeSSHd shortcut again and set the home path in SFTP tab to "C:\Program Files\Red Hat Directory Password Synchronization"


 e. Make IPA CA trusted
    From command prompt
    > cd C:\Program Files\Red Hat Directory Password Synchronization
    > certutil -d . -N (this will ask for password. Give "password")
    > certutil -d . -A -n "IPA CA" -t CT,, -a -i c:\path\to\ipaca.crt
 
 f. Restart AD Server

6. Make sure time is synchronized between both servers

7. The automation script will restart the PassSync service again after winsync agreement is established. No need of any manual intervention from this point onwards.
