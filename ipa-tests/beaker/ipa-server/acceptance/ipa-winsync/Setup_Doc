# Setting up winsync agreement between IPA and AD

# Setup AD

1. Install Windows Server 2008 R2 Standard on a machine
2. Set time zone same as ipa server
3. Set static IP or make sure the hostname is resolvable (you can skip intalling dns during active directory service install. But for automation please install DNS)
4. Stop firewalls
   Go to Start > Administrative Tools > Windows Firewall with Advanced Security.  Click on the Windows Firewall with Advanced Security and switch off all Profiles (Domain, Private, Public)
5. Open server manager. Do "Add Roles" and select Active Directory Services.
6. For making it a domain controller go to Start > Run and type dcpromo and hit return
   Follow the wizard and complete setting up the Server as a domain controller.
* Enter AD FQDN as "adrealm.com"
* At "Choose a Deployment Configuration" select "Create a new domain in a new forest"
* At "Set forest Functional Level" select Windows Server 2008 R2 from the dropdown
* Uncheck DNS if not required (This is required for automation)

7. Reboot the machine once done
8. After reboot login with username as "domainname\administrator" and password or use rdesktop 
# rdesktop <AD server IP> -u administrator -p Secret123 -d adrelm.com &

9. Open Server Manager to Add Role of Active Directory Certificate Services (Install the Certificate Services in Enterprise Root Mode. Active Directory will then automatically enroll to retrieve its SSL server certificate. )

10. Copy the generated cert from the above step to a file by double clicking on c:\Windows\System32\CertSrv\CertEnroll\<AD domainname_CAname.crt> (It will be of type Security Certificate). Go to details tab and click on Copy to file and save it as ADcert.cer.

11. Open that file in notepad and copy the contents exactly as it is to a file IPA server and save it as ADcert.cer.

12. Add DNS records in forward and reverse for IPA server.

# Setup IPA
# Only step 4 is required during automation. Steps 1-3 are managed by quickinstall

1. Install RHEL on a machine

2. Install latest ipa-server packages
  # yum install ipa-server bind-dyndb-ldap -y

3. Setup ipa server with below command or use quickinstall automated script
# ipa-server-install --setup-dns

4. Copy file /etc/ipa/ca.crt on the AD server as IPAcert.cer

5. Make sure both IPA and AD servers are resolvable and time is in sync


# Install PassSync and Import IPA cert in AD server database

1. Download passync from below link on to the AD server
https://wiki.idm.lab.bos.redhat.com/share/builds/components/winsync/passsync/20100512.1/release/

2. Install and configure Passsync with the following values

Hostname: <IPA server name>
Port: 636
Username: uid=passsync,cn=sysaccounts,cn=etc,dc=adrelm,dc=com
Password: password
Cert Token: Secret123
search base: cn=users,cn=accounts,dc=adrelm,dc=com

3. Copy the IPA cert file (IPAcert.cer) to C:\Program Files\Red Hat Directory Password Synchronization and from command prompt execute the commands
> cd C:\Program Files\Red Hat Directory Password Synchronization
> certutil -d . -N (this will ask for password. Give "password")
> certutil -d . -A -n "IPA CA" -t CT,, -a -i IPAcert.cer

4. Restart AD Server

5. After reboot go to 
Start > Run > Type Sevices.msc > Look for Password Sync service and restart the service if it is not started

6. Check file C:\Program Files\Red Hat Directory Password Synchronization\passsync.log for any errors


# Import AD cert in IPA server
# The following steps are managed by the automation script

1. Copy the Adcert.cer file in /etc/dirsrv/slapd-TESTRELM-COM

2. Import the Cert in the database with the following command
# certutil -d . -A -i ADcert.cer -n "AD Cert" -t "CT,C,C" -a
# certutil -d . -L {for listing the certs}
# certutil -d . -L -n "Cert name used" {For reading the cert file that was imported}

3. Add entry in /etc/openldap/ldap.conf file
TLS_CACERTDIR /etc/dirsrv/slapd-TESTRELM-COM

4. Create winsync agreement
# ipa-replica-manage connect --winsync --passsync=password --cacert=/etc/dirsrv/slapd-TESTRELM-COM/ADcert.cer melman.adrelm.com --binddn "cn=Administrator,cn=Users,dc=adrelm,dc=com" --bindpw Secret123 -v -p Secret123
