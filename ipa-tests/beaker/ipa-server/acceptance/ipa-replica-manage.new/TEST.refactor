ENV: 

        M
       / \
      R1  R2
           \
            R3
             \
              R4

MASTER          ipa_install_master
REPLICA1   ipa_install_replica $MASTER
REPLICA2   ipa_install_replica $MASTER
REPLICA3   ipa_install_replica $REPLICA2
REPLICA4   ipa_install_replica $REPLICA3

* tests must be run twice to run both with, and without password

########################################

# irm_version_pos_0001 - version
    ipa-replica-manage --version

# irm_list_pos_0001 - list, no name
    ipa-replica-manage list

# irm_list_pos_0002 - list, with name
    ipa-replica-manage list $MASTER
    ipa-replica-manage list $REPLICA1
    ipa-replica-manage list $REPLICA2
    ipa-replica-manage list $REPLICA3
    ipa-replica-manage list $REPLICA4

# irm_list_pos_0003 - list, no name, with verbose
    ipa-replica-manage list -v 

# irm_list_pos_0004 - list, with name, with verbose
    ipa-replica-manage list -v $MASTER

# irm_list_pos_0005 - list, with name, remote
    ipa-replica-manage list -H $MASTER $MASTER
    ipa-replica-manage list -H $REPLICA1 $MASTER
    ipa-replica-manage list -H $REPLICA2 $MASTER
    ipa-replica-manage list -H $REPLICA3 $MASTER
    ipa-replica-manage list -H $REPLICA4 $MASTER

# irm_list_neg_0001 - list fail, no agreement, with name
    ipa-replica-manage list $REPLICA1 | grep -v $REPLICA2

# irm_list_neg_0002 - list fail, no agreement, with name, remote
    ipa-replica-manage list -H $REPLICA1 $REPLICA1 | grep -v $REPLICA2

# irm_list_neg_0003 - list fail, non-existent host, with name
    ipa-replica-manage list dne.$DOMAIN 

# irm_list_neg_0004 - list fail, after uninstalling replica, with name [BZ#754739]
    irm_uninstall $REPLICA4
    ipa-replica-manage list $MASTER|grep -v $REPLICA4
    irm_install $REPLICA4 $REPLICA3

# irm_disconnect_pos_0001 - disconnect, master to replica2 agreement
    ipa-replica-manage connect $REPLICA1 $REPLICA4    # prep for test
    ipa-replica-manage disconnect $MASTER $REPLICA2   # test 
    ipa-replica-manage connect $MASTER $REPLICA2      # undo after test
    ipa-replica-manage disconnect $REPLICA1 $REPLICA4 # undo after test
??? Should I add data on 1 and test that I can see it on 4? ???

# irm_disconnect_pos_0002 - disconnect, master to replica2 agreement, remote
    ipa-replica-manage connect $REPLICA1 $REPLICA4    
    ipa-replica-manage -H $REPLICA1 disconnect $MASTER $REPLICA2
    ipa-replica-manage connect $MASTER $REPLICA2      
    ipa-replica-manage disconnect $REPLICA1 $REPLICA4 
??? Should I add data on 1 and test that I can see it on 4? ???
    
# irm_disconnect_neg_0001 - disconnect fail, replica with last agreement
    ipa-replica-manage disconnect $REPLICA3 $REPLICA4
    grep "Cannot remove the last replication link"
    grep "Please use the 'del' command to remove it from the domain"

# irm_disconnect_neg_0002 - disconnect fail, replica with last agreement, remote
    ipa-replica-manage -H $REPLICA1 disconnect $REPLICA3 $REPLICA4
    grep "Cannot remove the last replication link"
    grep "Please use the 'del' command to remove it from the domain"

# irm_disconnect_neg_0003 - disconnect fail, non-existent replica
    ipa-replica-manage disconnect $MASTER dne.$DOMAIN
    grep "'$MASTER' has no replication agreement for 'dne.$DOMAIN'"

# irm_disconnect_neg_0004 - disconnect fail, non-existent replica, remote
    ipa-replica-manage -H $REPLICA2 disconnect $MASTER dne.$DOMAIN
    grep "'$MASTER' has no replication agreement for 'dne.$DOMAIN'"

# irm_disconnect_neg_0005 - disconnect fail, after already disconnected
    ipa-replica-manage connect $REPLICA1 $REPLICA4 # prep for test
    ipa-replica-manage disconnect $REPLICA3 $REPLICA4 # pass
    ipa-replica-manage disconnect $REPLICA3 $REPLICA4 
    grep "'$REPLICA3' has no replication agreement for '$REPLICA4'"
    ipa-replica-manage connect $REPLICA3 $REPLICA4
    ipa-replica-manage disconnect $REPLICA1 $REPLICA4 # undo after test

# irm_disconnect_neg_0006 - disconnect fail, after already disconnected, remote
    ipa-replica-manage connect $REPLICA1 $REPLICA4 # prep for test
    ipa-replica-manage disconnect $REPLICA3 $REPLICA4 # pass
    ipa-replica-manage -H $REPLICA4 disconnect $REPLICA3 $REPLICA4 
    grep "'$REPLICA3' has no replication agreement for '$REPLICA4'"
    ipa-replica-manage connect $REPLICA3 $REPLICA4
    ipa-replica-manage disconnect $REPLICA1 $REPLICA4 # undo after test

# irm_connect_pos_0001 - connect, replica1 to replica4
    ipa-replica-manage connect $REPLICA1 $REPLICA4
    ssh $REPLICA1 "ipa group-add testgroup1"
    ssh $REPLICA4 "ipa group-show testgroup1" # pass
    ipa-replica-manage disconnect $REPLICA1 $REPLICA4

# irm_connect_pos_0002 - connect, replica1 to replica4, remote
    ipa-replica-manage -H $REPLICA3 connect $REPLICA1 $REPLICA4
    ssh $REPLICA4 "ipa group-add testgroup2"
    ssh $REPLICA1 "ipa group-show testgroup2" # pass
    ipa-replica-manage disconnect $REPLICA1 $REPLICA4

# irm_connect_neg_0001 - connect fail, existing agreement
    ipa-replica-manage connect $MASTER $REPLICA1
    grep "A replication agreement to $REPLICA1 already exists"

# irm_connect_neg_0002 - connect fail, existing agreement, remote
    ipa-replica-manage -H $REPLICA1 connect $MASTER $REPLICA1
    grep "A replication agreement to $REPLICA1 already exists"

# irm_forcesync_pos_0001 - forcesync, master from replica1
    ipa-replica-manage forcesync --from=$REPLICA1

# irm_forcesync_pos_0002 - forcesync, master from replica1, remote
    ipa-replica-manage -H $REPLICA2 forcesync --from=$REPLICA1

# irm_forcesync_pos_0003 - forcesync, replica2 from replica3
    ipa-replica-manage forcesync --from=$REPLICA3

# irm_forcesync_pos_0004 - forcesync, replica2 from replica3, remote
    ipa-replica-manage -H $REPLICA1 forcesync --from=$REPLICA3
     
# irm_forcesync_pos_0005 - forcesync, replica3 from replica4
     ipa-replica-manage forcesync --from=$REPLICA4
     
# irm_forcesync_pos_0006 - forcesync, replica3 from replica4, remote
     ipa-replica-manage -H $REPLICA2 forcesync --from=$REPLICA4
     
# irm_forcesync_neg_0001 - forcesync fail, without --from
     ipa-replica-manage forcesync 
     grep "force-sync requires the option --from"

# irm_forcesync_neg_0002 - forcesync fail, without --from, remote
     ipa-replica-manage -H $REPLICA1 forcesync 
     grep "force-sync requires the option --from"

# irm_forcesync_neg_0003 - forcesync fail, from self
    ipa-replica-manage forcesync --from=$(hostname)

# irm_forcesync_neg_0004 - forcesync fail, from self, remote
    ipa-replica-manage -H $REPLICA4 forcesync --from=$(hostname)

# irm_forcesync_neg_0005 - forcesync fail, from non-existent replica
    ipa-replica-manage forcesync --from=dne.$DOMAIN
    grep "'$MASTER' has no replication agreement for 'dne.$DOMAIN'"

# irm_forcesync_neg_0006 - forcesync fail, from non-existent replica, remote
    ipa-replica-manage -H $REPLICA2 forcesync --from=dne.$DOMAIN
    grep "'$MASTER' has no replication agreement for 'dne.$DOMAIN'"

# irm_forcesync_neg_0007 - forcesync fail, with no agreement
    ipa-replica-manage del $REPLICA1
    ipa-replica-manage forcesync --from=$REPLICA1
    grep "some error?"
    irm_uninstall $REPLICA1
    irm_install $REPLICA1 $MASTER

# irm_forcesync_neg_0008 - forcesync fail, with no agreement, remote
    ipa-replica-manage del $REPLICA1
    ipa-replica-manage -H $MASTER forcesync --from=$REPLICA1
    grep "some error?"
    irm_uninstall $REPLICA1
    irm_install $REPLICA1 $MASTER

# irm_reinitialize_pos_0001 - reinitialize, master from replica1 [BZ#831661]
    ssh $MASTER "ipa-replica-manage re-initialize --from=$REPLICA1"
    grep "Update succeeded"
    irm_bugcheck_831661 $tmpout $REPLICA1 

# irm_reinitialize_pos_0002 - reinitialize, replica2 from master, remote [BZ#831661]
    ipa-replica-manage -H $REPLICA2 re-initialize --from=$MASTER
    grep "Update succeeded"
    irm_bugcheck_831661 $tmpout $MASTER 

# irm_reinitialize_pos_0003 - reinitialize, replica3 from replica2 [BZ#831661]
    ssh $REPLICA3 "ipa-replica-manage re-initialize --from=$REPLICA2"
    grep "Update succeeded"
    irm_bugcheck_831661 $tmpout $REPLICA1 

# irm_reinitialize_pos_0004 - reinitialize, replica4 from replica3, remote [BZ#831661]
    ipa-replica-manage -H $REPLICA4 re-initialize --from=$REPLICA3
    grep "Update succeeded"
    irm_bugcheck_831661 $tmpout $REPLICA1 

# irm_reinitialize_neg_0001 - reinitialize fail, without --from
    ipa-replica-manage reinitialize 
    grep "re-initialize requires the option --from"

# irm_reinitialize_neg_0002 - reinitialize fail, without --from, remote
    ipa-replica-manage -H $REPLICA1 reinitialize
    grep "re-initialize requires the option --from"

# irm_reinitialize_neg_0003 - reinitialize fail, from self
    ipa-replica-manage reinitialize --from=$(hostname)
    grep "'$MASTER' has no replication agreement for '$MASTER'"

# irm_reinitialize_neg_0004 - reinitialize fail, from self, remote
    ipa-replica-manage -H $REPLICA1 reinitialize --from=$REPLICA1
    grep "'$REPLICA1' has no replication agreement for '$REPLICA1'"

# irm_reinitialize_neg_0005 - reinitialize fail, from non-existent replica
    ipa-replica-manage  reinitialize --from=dne.$DOMAIN
    grep "'$MASTER' has no replication agreement for 'dne.$DOMAIN'"

# irm_reinitialize_neg_0006 - reinitialize fail, from non-existent replica, remote
    ipa-replica-manage  -H $MASTER reinitialize --from=dne.$DOMAIN
    grep "'$MASTER' has no replication agreement for 'dne.$DOMAIN'"

# irm_reinitialize_neg_0007 - reinitialize fail, with no agreement
    ipa-replica-manage del $REPLICA1
    ipa-replica-manage reinitialize --from=$REPLICA1
    grep "'$MASTER' has no replication agreement for '$REPLICA1'"
    irm_uninstall $REPLICA1
    irm_install $REPLICA1 $MASTER

# irm_reinitialize_neg_0008 - reinitialize fail, with no agreement, remote
    ipa-replica-manage del $REPLICA1
    ipa-replica-manage -H $MASTER reinitialize --from=$REPLICA1
    grep "'$MASTER' has no replication agreement for '$REPLICA1'"
    irm_uninstall $REPLICA1
    irm_install $REPLICA1 $MASTER

# irm_del_pos_0001 - del, replica4
    ssh $REPLICA3 "ipa group-add delgroup1 --desc=desc"
    ssh $REPLICA4 "ipa group-show delgroup1"
    ipa-replica-manage del $REPLICA4 -f
    ipa-replica-manage list $REPLICA3|grep -v $REPLICA4
??? Should ipa-replica-manage list without specifying hostname show replica4 ???
    ssh $REPLICA3 "ipa group-del delgroup1"
    ssh $REPLICA4 "ipa group-show delgroup1" # fail
    ssh $REPLICA3 "ipa group-add delgroup2 --desc=desc"
    ssh $REPLICA4 "ipa group-show delgroup2"
    irm_uninstall $REPLICA4
    irm_install $REPLICA4 $REPLICA3

# irm_del_pos_0002 - del, replica4, remote
    ipa-replica-manage -H $MASTER del $REPLICA1 -f
    ipa-replica-manage list $MASTER|grep -v $REPLICA1
??? Should ipa-replica-manage list without specifying hostname show replica1 ???
    ipa host-show $REPLICA1 # fail with errnum 2
    irm_uninstall $REPLICA1
    irm_install $REPLICA1 $MASTER

# irm_del_neg_0001 - del fail, with disconnected agreement
    ipa-replica-manage disconnect $REPLICA3 $REPLICA4
    ipa-replica-manage del $REPLICA3
    irm_bugcheck_826677
    ipa-replica-manage list $REPLICA2|grep $REPLICA3
    ipa-replica-manage connect $REPLICA3 $REPLICA4

# irm_del_neg_0002 - del fail, with disconnected agreement, remote
    ipa-replica-manage disconnect $REPLICA3 $REPLICA4
    ipa-replica-manage -H $REPLICA2 del $REPLICA3
    irm_bugcheck_826677
    ipa-replica-manage list $REPLICA2|grep $REPLICA3
    ipa-replica-manage connect $REPLICA3 $REPLICA4

# irm_del_neg_0003 - del fail, already deleted agreement [BZ#754524]
    ipa-replica-manage del $REPLICA1 -f
    ipa-replica-manage del $REPLICA1 -f
    grep "'$MASTER' has no replication agreement for '$REPLICA1'"
    irm_uninstall $REPLICA1
    irm_install $REPLICA1 $MASTER

# irm_del_neg_0004 - del fail, already deleted agreement, remote [BZ#754524]
    ipa-replica-manage del $REPLICA1 -f
    ipa-replica-manage -H $MASTER del $REPLICA1 -f
    grep "'$MASTER' has no replication agreement for '$REPLICA1'"
    irm_uninstall $REPLICA1
    irm_install $REPLICA1 $MASTER

# irm_del_neg_0005 - del fail, non-existent replica
    ipa-replica-manage del dne.$DOMAIN -f
    grep "'$MASTER' has no replication agreement for 'dne.$DOMAIN'"

# irm_del_neg_0006 - del fail, non-existent replica, remote
    ipa-replica-manage -H $REPLICA1 del dne.$DOMAIN -f
    grep "'$REPLICA1' has no replication agreement for 'dne.$DOMAIN'"


# functional topology change tests:

# start quickinstall tree2
        M
       / \
     r1   r2
           \
            r3
             \
              r4

#  connect r1 r4
        M
       / \
     r1   r2
      |   |
     r4---r3

# disconnect r2 r3
        M
       / \
     r1   r2
      |    
     r4---r3

# connect -H r2 r3
        M
       / \
     r1   r2
      |   |
     r4---r3

??? should I test fully connected too?
# connect m r3
# connect m r4
# connect r2 r4
# connect r2 r1
# connect r3 r1
          M
       r1 * r2
        r3 r4 

# disconnect m r3
# disconnect m r4
# disconnect r2 r4
# disconnect r2 r1
# disconnect r3 r1
        M
       / \
     r1   r2
      |   |
     r4---r3

# disconnect -H r1 r4
        M
       / \
     r1   r2
           \
            r3
             \
              r4
