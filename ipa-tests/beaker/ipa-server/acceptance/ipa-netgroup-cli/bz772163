# Variables

ngname=testuser200
userpre=testuser20

# Pre-work
ipa user-add ${userpre}0 --first=first --last=last
ipa user-add ${userpre}1 --first=first --last=last
ipa user-add ${userpre}2 --first=first --last=last
ipa user-add ${userpre}3 --first=first --last=last
ipa user-add ${userpre}4 --first=first --last=last
ipa user-add ${userpre}5 --first=first --last=last
ipa user-add ${userpre}6 --first=first --last=last
ipa netgroup-add ${ngname} --desc=test
ipa netgroup-add-member ${ngname} --users=${userpre}0

# change sssd params
sed -i 's/\(\[domain.*\]\)$/\1\nentry_cache_timeout = 1/' /etc/sssd/sssd.conf
service sssd restart

# Test that you can see the initial netgroup
date
sleep 2
time getent netgroup ${ngname}
sleep 2
time getent netgroup ${ngname}
sleep 2
time getent netgroup ${ngname}

# Check new user entries added to netgroup
date
time ipa netgroup-add-member ${ngname} --users=${userpre}1
date
time getent netgroup ${ngname}
date
time ipa netgroup-add-member ${ngname} --users=${userpre}2
date
time getent netgroup ${ngname}
date
time ipa netgroup-add-member ${ngname} --users=${userpre}3
date
time getent netgroup ${ngname}
date
time ipa netgroup-add-member ${ngname} --users=${userpre}4
date
time getent netgroup ${ngname}
date
time ipa netgroup-add-member ${ngname} --users=${userpre}5
date
time getent netgroup ${ngname}
date
time ipa netgroup-add-member ${ngname} --users=${userpre}6
date
time getent netgroup ${ngname} 

# cleanup
ipa netgroup-del ${ngname}
for i in 0 1 2 3 4 5 6; do
	ipa user-del ${userpre}${i}
done
sed -i '/entry_cache_timeout = 1/d' /etc/sssd/sssd.conf
service sssd restart
