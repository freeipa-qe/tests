#!/bin/sh

echo "delete all ipa users"

echo "step 1. ldapsearch all accounts under 'cn=users,cn=accounts,<suffix>"

TEMP=/tmp/$RANDOM.txt
LDAPSEARCH=/usr/lib*/mozldap/ldapsearch
LDAPMODIFY=/usr/lib*/mozldap/ldapmodify
SUFFIX="DC=rhqa,DC=net"
BIND_DN="cn=directory manager"
BIND_PW="redhat123"
USER_DN="cn=users,cn=accounts,$SUFFIX"
GRP_DN="cn=groups,cn=accounts,$SUFFIX"
HOST=`hostname -f`
if touch $TEMP
then
	echo "using [$TEMP] as storage"
else
	echo "can not create storage file, exit"
	exit
fi

$LDAPSEARCH -h $HOST  -D "$BIND_DN" -w $BIND_PW -s sub -b $USER_DN "" "dn" | grep "dn" | grep -v "admin" | grep -v "dn: cn=users,cn=accounts,dc=rhqa,dc=net" | grep -v "version" | cut -d":" -f2 > $TEMP

for user in `cat $TEMP`
do
	echo $user
	$LDAPMODIFY -D "$BIND_DN" -w $BIND_PW -a -c <<_EOF_
dn: $user
changetype: delete
_EOF_
	
done

echo "step 2. ldapsearch all accounts under 'cn=groups,cn=accounts,<suffix>"

$LDAPSEARCH -h $HOST  -D "$BIND_DN" -w $BIND_PW -s sub -b $GRP_DN "" "dn" grep "dn:" | grep -v "dn: cn=groups,cn=accounts,dc=rhqa,dc=net" | grep -v "dn: cn=ipausers,cn=groups,cn=accounts,dc=rhqa,dc=net" | grep -v "dn: cn=editors,cn=groups,cn=accounts,dc=rhqa,dc=net" | grep -v "dn: cn=admins,cn=groups,cn=accounts,dc=rhqa,dc=net" | cut -d":" -f2 > $TEMP

for group in `cat $TEMP`
do
	echo $group
	$LDAPMODIFY -D "$BIND_DN" -w $BIND_PW -a -c <<_EOF_
dn: $group
changetype: delete
_EOF_
	
done


if [ -f $TEMP ];then
	echo "delete storage file [$TEMP]"
	rm $TEMP
fi


