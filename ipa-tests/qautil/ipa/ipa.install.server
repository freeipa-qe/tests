#!/bin/sh

echo "this will do the following:
1. copy repo file to /etc/yum.repos.d/
2. yum install ipa-server
3. verify te ipa build (make sure it is 1.1 version)
4. call ipa-server-install
"

BASE_DIR=~/qautil

REPO_FILE=""

echo "[step 1] copy repo file to /etc/yum.repos.d/"
if uname -a | grep "i386" > /dev/null 2>&1
then
	REPO_FILE=$BASE_DIR/qaconfig/ipa32.repo
elif uname -a | grep "x86_64" > /dev/null 2>&1
then
	REPO_FILE=$BASE_DIR/qaconfig/ipa64.repo
fi

if [ -f $REPO_FILE ]
then
	echo "copy repo: [$REPO_FILE]"
	cp -f $REPO_FILE /etc/yum.repos.d/.
	ls -l /etc/yum.repos.d
fi

echo "[step 2] yum install ipa-server"
yes yes | yum install ipa-server

echo "[step 3] check installed ipa version"
INFO=`rpm -qi ipa-server`
if echo $INFO | grep "1.1.0" > /dev/null 2>&1
then
	echo "IPA version check : 1.0, is correct"
else
	echo "IPA version check : FAILED"
	exit
fi
INFO=`rpm -qi redhat-ds-base`
if echo $INFO | grep "8.0.5" > /dev/null 2>&1
then
	echo "DS version check: 8.0.5, is correct"
else
	echo "DS version is not correct"
	exit
fi

echo "[step 4] install ipa server"

HOSTNAME=`hostname -f`
REALM="RHQA.NET"
PW="redhat123"

echo "	command called
	ipa-server-install -N -U --hostname=$HOSTNAME -r $REALM -p $PW -P $PW -a $PW -u root
"
ipa-server-install -N -U --hostname=$HOSTNAME -r $REALM -p $PW -P $PW -a $PW -u root

echo "verity the installation: kinit as admin with given password and search admin"
echo $PW | kinit admin
ipa-finduser -a admin

echo "============= end ==============="
echo ""
